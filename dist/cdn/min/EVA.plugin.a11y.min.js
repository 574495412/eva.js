!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@eva/eva.js"),require("pixi.js")):"function"==typeof define&&define.amd?define(["exports","@eva/eva.js","pixi.js"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).EVA=t.EVA||{},t.EVA.plugin=t.EVA.plugin||{},t.EVA.plugin.a11y={}),t.EVA,t.PIXI)}(this,(function(t,e,n){"use strict";function r(t,e,n,r){var o,i=arguments.length,a=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(i<3?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a}function o(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))}const i=(t,e)=>{const{width:n,height:r,position:o,left:i=0,top:a=0,zIndex:s,pointerEvents:c,background:h}=e;t.style.width=`${n}px`,t.style.height=`${r}px`,t.style.position=o,t.style.left=`${i}`,t.style.top=`${a}`,t.style.zIndex=`${s}`,t.style.pointerEvents=c,t.style.background=h,t.style.border="none",t.style.overflow="hidden"};class a extends e.Component{constructor(t){super(),Object.assign(this,t);const{hint:e="",event:n,delay:r=0,attr:o={},role:i="",props:a={},state:s={}}=t;this.hint=e,this.event=n,this.delay=r,this.attr=o,this.role=i,this.props=a,this.state=s,this.a11yId=`_${function(t){let e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=[],r=e.length;for(let o=0;o<t;o++)n[o]=e[0|Math.random()*r];return n.join("")}(6)}`}}a.componentName="A11y",r([e.decorators.IDEProp],a.prototype,"interactive",void 0),r([e.decorators.IDEProp],a.prototype,"hint",void 0),r([e.decorators.IDEProp],a.prototype,"event",void 0),r([e.decorators.IDEProp],a.prototype,"delay",void 0),r([e.decorators.IDEProp],a.prototype,"role",void 0),r([e.decorators.IDEProp],a.prototype,"props",void 0),r([e.decorators.IDEProp],a.prototype,"state",void 0),r([e.decorators.IDEProp],a.prototype,"attr",void 0),r([e.decorators.IDEProp],a.prototype,"a11yId",void 0);const s="absolute";var c,h,u,p;t.A11yActivate=void 0,(c=t.A11yActivate||(t.A11yActivate={}))[c.ENABLE=0]="ENABLE",c[c.DISABLE=1]="DISABLE",c[c.CHECK=2]="CHECK",function(t){t.NONE="none",t.AUTO="auto"}(h||(h={})),function(t){t.DEBUG="rgba(255,0,0,0.5)",t.NONE="transparent"}(u||(u={})),function(t){t.BUTTON="button",t.DIV="div"}(p||(p={}));class l extends n.Application{constructor(t){t.autoStart=!1,super(t)}}class f extends n.Container{}n.mesh.NineSlicePlane;function d(t,e){return t===e||t!=t&&e!=e}function v(t,e){for(var n=t.length;n--;)if(d(t[n][0],e))return n;return-1}n.extras.TilingSprite;var y=Array.prototype.splice;function g(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}g.prototype.clear=function(){this.__data__=[],this.size=0},g.prototype.delete=function(t){var e=this.__data__,n=v(e,t);return!(n<0)&&(n==e.length-1?e.pop():y.call(e,n,1),--this.size,!0)},g.prototype.get=function(t){var e=this.__data__,n=v(e,t);return n<0?void 0:e[n][1]},g.prototype.has=function(t){return v(this.__data__,t)>-1},g.prototype.set=function(t,e){var n=this.__data__,r=v(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this};var m="object"==typeof global&&global&&global.Object===Object&&global,b="object"==typeof self&&self&&self.Object===Object&&self,_=m||b||Function("return this")(),j=_.Symbol,O=Object.prototype,E=O.hasOwnProperty,w=O.toString,A=j?j.toStringTag:void 0;var C=Object.prototype.toString;var S=j?j.toStringTag:void 0;function x(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":S&&S in Object(t)?function(t){var e=E.call(t,A),n=t[A];try{t[A]=void 0;var r=!0}catch(t){}var o=w.call(t);return r&&(e?t[A]=n:delete t[A]),o}(t):function(t){return C.call(t)}(t)}function P(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function N(t){if(!P(t))return!1;var e=x(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}var I,M=_["__core-js_shared__"],R=(I=/[^.]+$/.exec(M&&M.keys&&M.keys.IE_PROTO||""))?"Symbol(src)_1."+I:"";var T=Function.prototype.toString;function D(t){if(null!=t){try{return T.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var k=/^\[object .+?Constructor\]$/,z=Function.prototype,B=Object.prototype,$=z.toString,L=B.hasOwnProperty,V=RegExp("^"+$.call(L).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Y(t){return!(!P(t)||(e=t,R&&R in e))&&(N(t)?V:k).test(D(t));var e}function U(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return Y(n)?n:void 0}var X=U(_,"Map"),F=U(Object,"create");var W=Object.prototype.hasOwnProperty;var G=Object.prototype.hasOwnProperty;function H(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function q(t,e){var n,r,o=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof e?"string":"hash"]:o.map}function K(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}H.prototype.clear=function(){this.__data__=F?F(null):{},this.size=0},H.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},H.prototype.get=function(t){var e=this.__data__;if(F){var n=e[t];return"__lodash_hash_undefined__"===n?void 0:n}return W.call(e,t)?e[t]:void 0},H.prototype.has=function(t){var e=this.__data__;return F?void 0!==e[t]:G.call(e,t)},H.prototype.set=function(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=F&&void 0===e?"__lodash_hash_undefined__":e,this},K.prototype.clear=function(){this.size=0,this.__data__={hash:new H,map:new(X||g),string:new H}},K.prototype.delete=function(t){var e=q(this,t).delete(t);return this.size-=e?1:0,e},K.prototype.get=function(t){return q(this,t).get(t)},K.prototype.has=function(t){return q(this,t).has(t)},K.prototype.set=function(t,e){var n=q(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this};function J(t){var e=this.__data__=new g(t);this.size=e.size}J.prototype.clear=function(){this.__data__=new g,this.size=0},J.prototype.delete=function(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n},J.prototype.get=function(t){return this.__data__.get(t)},J.prototype.has=function(t){return this.__data__.has(t)},J.prototype.set=function(t,e){var n=this.__data__;if(n instanceof g){var r=n.__data__;if(!X||r.length<199)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new K(r)}return n.set(t,e),this.size=n.size,this};function Q(t){var e=-1,n=null==t?0:t.length;for(this.__data__=new K;++e<n;)this.add(t[e])}function Z(t,e){for(var n=-1,r=null==t?0:t.length;++n<r;)if(e(t[n],n,t))return!0;return!1}Q.prototype.add=Q.prototype.push=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this},Q.prototype.has=function(t){return this.__data__.has(t)};function tt(t,e,n,r,o,i){var a=1&n,s=t.length,c=e.length;if(s!=c&&!(a&&c>s))return!1;var h=i.get(t),u=i.get(e);if(h&&u)return h==e&&u==t;var p=-1,l=!0,f=2&n?new Q:void 0;for(i.set(t,e),i.set(e,t);++p<s;){var d=t[p],v=e[p];if(r)var y=a?r(v,d,p,e,t,i):r(d,v,p,t,e,i);if(void 0!==y){if(y)continue;l=!1;break}if(f){if(!Z(e,(function(t,e){if(a=e,!f.has(a)&&(d===t||o(d,t,n,r,i)))return f.push(e);var a}))){l=!1;break}}else if(d!==v&&!o(d,v,n,r,i)){l=!1;break}}return i.delete(t),i.delete(e),l}var et=_.Uint8Array;function nt(t){var e=-1,n=Array(t.size);return t.forEach((function(t,r){n[++e]=[r,t]})),n}function rt(t){var e=-1,n=Array(t.size);return t.forEach((function(t){n[++e]=t})),n}var ot=j?j.prototype:void 0,it=ot?ot.valueOf:void 0;var at=Array.isArray;var st=Object.prototype.propertyIsEnumerable,ct=Object.getOwnPropertySymbols,ht=ct?function(t){return null==t?[]:(t=Object(t),function(t,e){for(var n=-1,r=null==t?0:t.length,o=0,i=[];++n<r;){var a=t[n];e(a,n,t)&&(i[o++]=a)}return i}(ct(t),(function(e){return st.call(t,e)})))}:function(){return[]};function ut(t){return null!=t&&"object"==typeof t}function pt(t){return ut(t)&&"[object Arguments]"==x(t)}var lt=Object.prototype,ft=lt.hasOwnProperty,dt=lt.propertyIsEnumerable,vt=pt(function(){return arguments}())?pt:function(t){return ut(t)&&ft.call(t,"callee")&&!dt.call(t,"callee")};var yt="object"==typeof t&&t&&!t.nodeType&&t,gt=yt&&"object"==typeof module&&module&&!module.nodeType&&module,mt=gt&&gt.exports===yt?_.Buffer:void 0,bt=(mt?mt.isBuffer:void 0)||function(){return!1},_t=/^(?:0|[1-9]\d*)$/;function jt(t,e){var n=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==n||"symbol"!=n&&_t.test(t))&&t>-1&&t%1==0&&t<e}function Ot(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991}var Et={};Et["[object Float32Array]"]=Et["[object Float64Array]"]=Et["[object Int8Array]"]=Et["[object Int16Array]"]=Et["[object Int32Array]"]=Et["[object Uint8Array]"]=Et["[object Uint8ClampedArray]"]=Et["[object Uint16Array]"]=Et["[object Uint32Array]"]=!0,Et["[object Arguments]"]=Et["[object Array]"]=Et["[object ArrayBuffer]"]=Et["[object Boolean]"]=Et["[object DataView]"]=Et["[object Date]"]=Et["[object Error]"]=Et["[object Function]"]=Et["[object Map]"]=Et["[object Number]"]=Et["[object Object]"]=Et["[object RegExp]"]=Et["[object Set]"]=Et["[object String]"]=Et["[object WeakMap]"]=!1;var wt,At="object"==typeof t&&t&&!t.nodeType&&t,Ct=At&&"object"==typeof module&&module&&!module.nodeType&&module,St=Ct&&Ct.exports===At&&m.process,xt=function(){try{var t=Ct&&Ct.require&&Ct.require("util").types;return t||St&&St.binding&&St.binding("util")}catch(t){}}(),Pt=xt&&xt.isTypedArray,Nt=Pt?(wt=Pt,function(t){return wt(t)}):function(t){return ut(t)&&Ot(t.length)&&!!Et[x(t)]},It=Object.prototype.hasOwnProperty;function Mt(t,e){var n=at(t),r=!n&&vt(t),o=!n&&!r&&bt(t),i=!n&&!r&&!o&&Nt(t),a=n||r||o||i,s=a?function(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}(t.length,String):[],c=s.length;for(var h in t)!e&&!It.call(t,h)||a&&("length"==h||o&&("offset"==h||"parent"==h)||i&&("buffer"==h||"byteLength"==h||"byteOffset"==h)||jt(h,c))||s.push(h);return s}var Rt=Object.prototype;var Tt=function(t,e){return function(n){return t(e(n))}}(Object.keys,Object),Dt=Object.prototype.hasOwnProperty;function kt(t){if(n=(e=t)&&e.constructor,e!==("function"==typeof n&&n.prototype||Rt))return Tt(t);var e,n,r=[];for(var o in Object(t))Dt.call(t,o)&&"constructor"!=o&&r.push(o);return r}function zt(t){return null!=(e=t)&&Ot(e.length)&&!N(e)?Mt(t):kt(t);var e}function Bt(t){return function(t,e,n){var r=e(t);return at(t)?r:function(t,e){for(var n=-1,r=e.length,o=t.length;++n<r;)t[o+n]=e[n];return t}(r,n(t))}(t,zt,ht)}var $t=Object.prototype.hasOwnProperty;var Lt=U(_,"DataView"),Vt=U(_,"Promise"),Yt=U(_,"Set"),Ut=U(_,"WeakMap"),Xt="[object Map]",Ft="[object Promise]",Wt="[object Set]",Gt="[object WeakMap]",Ht="[object DataView]",qt=D(Lt),Kt=D(X),Jt=D(Vt),Qt=D(Yt),Zt=D(Ut),te=x;(Lt&&te(new Lt(new ArrayBuffer(1)))!=Ht||X&&te(new X)!=Xt||Vt&&te(Vt.resolve())!=Ft||Yt&&te(new Yt)!=Wt||Ut&&te(new Ut)!=Gt)&&(te=function(t){var e=x(t),n="[object Object]"==e?t.constructor:void 0,r=n?D(n):"";if(r)switch(r){case qt:return Ht;case Kt:return Xt;case Jt:return Ft;case Qt:return Wt;case Zt:return Gt}return e});var ee=te,ne="[object Arguments]",re="[object Array]",oe="[object Object]",ie=Object.prototype.hasOwnProperty;function ae(t,e,n,r,o,i){var a=at(t),s=at(e),c=a?re:ee(t),h=s?re:ee(e),u=(c=c==ne?oe:c)==oe,p=(h=h==ne?oe:h)==oe,l=c==h;if(l&&bt(t)){if(!bt(e))return!1;a=!0,u=!1}if(l&&!u)return i||(i=new J),a||Nt(t)?tt(t,e,n,r,o,i):function(t,e,n,r,o,i,a){switch(n){case"[object DataView]":if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case"[object ArrayBuffer]":return!(t.byteLength!=e.byteLength||!i(new et(t),new et(e)));case"[object Boolean]":case"[object Date]":case"[object Number]":return d(+t,+e);case"[object Error]":return t.name==e.name&&t.message==e.message;case"[object RegExp]":case"[object String]":return t==e+"";case"[object Map]":var s=nt;case"[object Set]":var c=1&r;if(s||(s=rt),t.size!=e.size&&!c)return!1;var h=a.get(t);if(h)return h==e;r|=2,a.set(t,e);var u=tt(s(t),s(e),r,o,i,a);return a.delete(t),u;case"[object Symbol]":if(it)return it.call(t)==it.call(e)}return!1}(t,e,c,n,r,o,i);if(!(1&n)){var f=u&&ie.call(t,"__wrapped__"),v=p&&ie.call(e,"__wrapped__");if(f||v){var y=f?t.value():t,g=v?e.value():e;return i||(i=new J),o(y,g,n,r,i)}}return!!l&&(i||(i=new J),function(t,e,n,r,o,i){var a=1&n,s=Bt(t),c=s.length;if(c!=Bt(e).length&&!a)return!1;for(var h=c;h--;){var u=s[h];if(!(a?u in e:$t.call(e,u)))return!1}var p=i.get(t),l=i.get(e);if(p&&l)return p==e&&l==t;var f=!0;i.set(t,e),i.set(e,t);for(var d=a;++h<c;){var v=t[u=s[h]],y=e[u];if(r)var g=a?r(y,v,u,e,t,i):r(v,y,u,t,e,i);if(!(void 0===g?v===y||o(v,y,n,r,i):g)){f=!1;break}d||(d="constructor"==u)}if(f&&!d){var m=t.constructor,b=e.constructor;m==b||!("constructor"in t)||!("constructor"in e)||"function"==typeof m&&m instanceof m&&"function"==typeof b&&b instanceof b||(f=!1)}return i.delete(t),i.delete(e),f}(t,e,n,r,o,i))}function se(t,e,n,r,o){return t===e||(null==t||null==e||!ut(t)&&!ut(e)?t!=t&&e!=e:ae(t,e,n,r,se,o))}class ce{constructor({game:t,rendererSystem:e}){this.renderers=[],this.game=t,this.rendererSystem=e}register(...t){for(const e of t)e.game=this.game,e.rendererManager=this.rendererSystem.rendererManager,e.containerManager=this.rendererSystem.containerManager,this.renderers.push(e)}componentChanged(t){for(const n of t)for(const t of this.renderers){const r=t.observerInfo[n.componentName];if(r){if([e.OBSERVER_TYPE.ADD,e.OBSERVER_TYPE.REMOVE].indexOf(n.type)>-1){try{t.componentChanged&&t.componentChanged(n)}catch(t){console.error(`gameObject: ${n.gameObject.name}, ${n.componentName} is error.`,n,t)}continue}if(r.findIndex((t=>{return e=t,r=n.prop,se(e,r);var e,r}))>-1)try{t.componentChanged&&t.componentChanged(n)}catch(t){console.error(`gameObject: ${n.gameObject&&n.gameObject.name}, ${n.componentName} is componentChanged error.`,n,t)}}}}update(t){for(const e of t.components)for(const n of this.renderers){const r=[];if(n.observerInfo[e.name]&&-1===r.indexOf(t)){r.push(t);try{n.rendererUpdate&&n.rendererUpdate(t)}catch(n){console.info(`gameObject: ${t.name}, ${e.name} is update error`,n)}}}}}class he{constructor(){this.containerMap={}}addContainer({name:t,container:e}){this.containerMap[t]=e}getContainer(t){return this.containerMap[t]}removeContainer(t){var e;null===(e=this.containerMap[t])||void 0===e||e.destroy(!0),delete this.containerMap[t]}updateTransform({name:t,transform:e}){const n=this.containerMap[t];if(!n)return;const{anchor:r,origin:o,position:i,rotation:a,scale:s,size:c,skew:h}=e;n.rotation=a,n.scale=s,n.pivot.x=c.width*o.x,n.pivot.y=c.height*o.y,n.skew=h;let u=i.x,p=i.y;if(e.parent){const t=e.parent;u+=t.size.width*r.x,p+=t.size.height*r.y}n.position={x:u,y:p}}}var ue=function(t){var e={exports:{}};return t(e,e.exports),e.exports}((function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}function o(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function i(t,e,r,i,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var s=new o(r,i||t,a),c=n?n+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],s]:t._events[c].push(s):(t._events[c]=s,t._eventsCount++),t}function a(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function s(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),s.prototype.eventNames=function(){var t,r,o=[];if(0===this._eventsCount)return o;for(r in t=this._events)e.call(t,r)&&o.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(t)):o},s.prototype.listeners=function(t){var e=n?n+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,a=new Array(i);o<i;o++)a[o]=r[o].fn;return a},s.prototype.listenerCount=function(t){var e=n?n+t:t,r=this._events[e];return r?r.fn?1:r.length:0},s.prototype.emit=function(t,e,r,o,i,a){var s=n?n+t:t;if(!this._events[s])return!1;var c,h,u=this._events[s],p=arguments.length;if(u.fn){switch(u.once&&this.removeListener(t,u.fn,void 0,!0),p){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,e),!0;case 3:return u.fn.call(u.context,e,r),!0;case 4:return u.fn.call(u.context,e,r,o),!0;case 5:return u.fn.call(u.context,e,r,o,i),!0;case 6:return u.fn.call(u.context,e,r,o,i,a),!0}for(h=1,c=new Array(p-1);h<p;h++)c[h-1]=arguments[h];u.fn.apply(u.context,c)}else{var l,f=u.length;for(h=0;h<f;h++)switch(u[h].once&&this.removeListener(t,u[h].fn,void 0,!0),p){case 1:u[h].fn.call(u[h].context);break;case 2:u[h].fn.call(u[h].context,e);break;case 3:u[h].fn.call(u[h].context,e,r);break;case 4:u[h].fn.call(u[h].context,e,r,o);break;default:if(!c)for(l=1,c=new Array(p-1);l<p;l++)c[l-1]=arguments[l];u[h].fn.apply(u[h].context,c)}}return!0},s.prototype.on=function(t,e,n){return i(this,t,e,n,!1)},s.prototype.once=function(t,e,n){return i(this,t,e,n,!0)},s.prototype.removeListener=function(t,e,r,o){var i=n?n+t:t;if(!this._events[i])return this;if(!e)return a(this,i),this;var s=this._events[i];if(s.fn)s.fn!==e||o&&!s.once||r&&s.context!==r||a(this,i);else{for(var c=0,h=[],u=s.length;c<u;c++)(s[c].fn!==e||o&&!s[c].once||r&&s[c].context!==r)&&h.push(s[c]);h.length?this._events[i]=1===h.length?h[0]:h:a(this,i)}return this},s.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&a(this,e)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,t.exports=s}));let pe=class extends ue{constructor({system:t,containerManager:e}){super(),this.name="Transform",this.waitRemoveIds=[],this.waitChangeScenes=[],this.containerManager=e,this.init(t)}init(t){this.system=t,this.on("changeScene",(({scene:t,mode:e,application:n})=>{this.waitChangeScenes.push({scene:t,mode:e,application:n})}))}update(){for(const t of this.waitRemoveIds)this.containerManager.removeContainer(t);this.waitRemoveIds=[];for(const t of this.waitChangeScenes){const e=this.containerManager.getContainer(t.scene.id);e&&(t.application.stage.removeChildren(),t.application.stage.addChild(e))}this.waitChangeScenes=[]}componentChanged(t){t.type===e.OBSERVER_TYPE.ADD?this.addContainer(t):t.type===e.OBSERVER_TYPE.CHANGE?this.change(t):t.type===e.OBSERVER_TYPE.REMOVE&&this.waitRemoveIds.push(t.gameObject.id)}addContainer(t){const e=new f;e.name=t.gameObject.name,this.containerManager.addContainer({name:t.gameObject.id,container:e});t.component.worldTransform=e.transform.worldTransform}change(t){const e=t.component;if(e.parent){this.containerManager.getContainer(e.parent.gameObject.id).addChild(this.containerManager.getContainer(t.gameObject.id));const n=t.gameObject.transform.parent&&t.gameObject.transform.parent.gameObject.getComponent("Render");n&&(n.sortDirty=!0)}else{const n=this.containerManager.getContainer(t.gameObject.id);delete e.worldTransform,n.parent&&n.parent.removeChild(n)}}destroy(){this.removeAllListeners(),this.waitRemoveIds=null,this.waitChangeScenes=null,this.system=null,this.containerManager=null}};pe=r([e.decorators.componentObserver({Transform:["_parent"]})],pe);var le,fe=pe;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.WEBGL=1]="WEBGL",t[t.CANVAS=2]="CANVAS"}(le||(le={}));const de=t=>{t.plugins.interaction.autoPreventDefault=!0,t.view.style.touchAction="none"},ve=t=>{t.plugins.interaction.autoPreventDefault=!1,t.view.style.touchAction="auto"};let ye=class extends e.System{constructor(){super(...arguments),this.multiApps=[]}init(t){this.params=t,this.application=this.createApplication(t),this.containerManager=new he,this.rendererManager=new ce({game:this.game,rendererSystem:this}),this.game.canvas=this.application.view,this.transform=new fe({system:this,containerManager:this.containerManager}),this.game.on("sceneChanged",(({scene:t,mode:n,params:r})=>{let o;switch(n){case e.LOAD_SCENE_MODE.SINGLE:o=this.application;break;case e.LOAD_SCENE_MODE.MULTI_CANVAS:o=this.createMultiApplication({params:r})}t.canvas=o.view,this.transform.emit("changeScene",{scene:t,mode:n,application:o})}))}registerObserver(t){const e=this.constructor.observerInfo;for(const n in t)e[n]||(e[n]=[]),e[n].push(...t[n])}createMultiApplication({params:t}){const e=this.createApplication(t);return this.multiApps.push(e),e}createApplication(t){t.view=t.canvas,t.renderType===le.CANVAS&&(t.forceCanvas=!0),n.ticker.shared.autoStart=!1,n.ticker.shared.stop();const e=new l(Object.assign({sharedTicker:!0},t));return void 0!==t.preventScroll&&(console.warn("PreventScroll property will deprecate at next major version, please use enableEnable instead. https://eva.js.org/#/tutorials/game"),t.preventScroll?ve(e.renderer):de(e.renderer)),void 0!==t.enableScroll&&(t.enableScroll?ve(e.renderer):de(e.renderer)),void 0===t.preventScroll&&void 0===t.enableScroll&&ve(e.renderer),e}update(){const t=this.componentObserver.clear();for(const e of t)this.transform.componentChanged(e);for(const t of this.game.gameObjects)this.containerManager.updateTransform({name:t.id,transform:t.transform}),this.rendererManager.update(t)}lateUpdate(t){this.transform.update(),this.application.ticker.update(t.time)}onDestroy(){this.application.destroy();for(const t of this.multiApps)t&&t.destroy();this.transform.destroy(),this.transform=null,this.params=null,this.rendererManager=null,this.containerManager=null,this.application=null,this.game=null,this.multiApps=null}resize(t,e){this.params.width=t,this.params.height=e,this.application.renderer.resize(t,e)}};ye.systemName="Renderer",ye=r([e.decorators.componentObserver({Transform:["_parent"]})],ye);var ge=ye;const me=["hint","event","delay","attr","role","props","state","a11yId","name"],be=function(t,e,n){["touchstart","touchend","tap"].forEach((r=>{t.emit(r,{stopPropagation:()=>n.stopPropagation(),data:{position:this.eventPosition},gameObject:e})}))};let _e=class extends e.System{constructor(t){super(t),this.cache=new Map,this.eventCache=new Map}get ratioX(){if(this._ratioX)return this._ratioX;return this.setRatio()?this._ratioX:0}get ratioY(){if(this._ratioY)return this._ratioY;return this.setRatio()?this._ratioY:0}init(e={}){return o(this,void 0,void 0,(function*(){const{activate:n=t.A11yActivate.CHECK,delay:r=100,checkA11yOpen:o=(()=>Promise.resolve(!1))}=e;switch(this.delay=r,n){case t.A11yActivate.CHECK:try{this.activate=yield o()}catch(t){this.activate=!1}break;case t.A11yActivate.DISABLE:this.activate=!1;break;case t.A11yActivate.ENABLE:this.activate=!0}if(this.debug=e.debug||!1,this.debug&&(this.activate=!0),!this.activate)return;const i=document.createElement("div");this.div=i,this.game.canvas.parentNode&&this.game.canvas.parentNode.appendChild(this.div)}))}setRatio(){const{width:t,height:e}=this.getCanvasBoundingClientRect(),{renderWidth:n,renderHeight:r}=this.getRenderRect();return this._ratioX=t/n,this._ratioY=e/r,!(!t&&!e)&&(this.initDiv(),!0)}getRenderRect(){const{params:t}=this.game.getSystem(ge)||{width:300,height:300},{height:e,width:n}=t;return{renderWidth:n,renderHeight:e}}getCanvasBoundingClientRect(){const{width:t,height:e,left:n,top:r}=this.game.canvas.getBoundingClientRect();return{width:t,height:e,left:n,top:r}}initDiv(){const{pageXOffset:t,pageYOffset:e}=window,{width:n,height:r,left:o,top:a}=this.getCanvasBoundingClientRect(),c={width:n,height:r,left:`${o+t}px`,top:`${a+e}px`,position:s,zIndex:3,pointerEvents:h.NONE,background:u.NONE};i(this.div,c),this.div.addEventListener("click",(t=>{const e=t.currentTarget,{left:n,top:r}=e.getBoundingClientRect(),o=(t.pageX-n)/this.ratioX,i=(t.pageY-r)/this.ratioY;this.eventPosition={x:o,y:i}}),!0)}update(){return o(this,void 0,void 0,(function*(){const t=this.componentObserver.clear();if(this.activate)for(const n of t)switch(n.type){case e.OBSERVER_TYPE.ADD:"Event"===n.componentName&&this.addEvent(n.gameObject),"A11y"===n.componentName&&this.add(n);break;case e.OBSERVER_TYPE.CHANGE:"Transform"===n.componentName&&this.transformChange(n);break;case e.OBSERVER_TYPE.REMOVE:"Event"===n.componentName&&this.removeEvent(n),"A11y"===n.componentName&&this.remove(n)}}))}remove(t){const e=t.component;if(!e)return;const{a11yId:n}=e,r=this.div.querySelector(`#${n}`);r&&this.div.removeChild(r),this.cache.delete(n)}add(t){if(!this.activate)return;const e=t.component,{gameObject:n}=t,{delay:r,a11yId:o}=e;let{event:i}=e;if(!n)return;const{transform:a}=n;if(!a)return;const s=document.createElement("div");this.cache.set(o,s),i||(i=n.getComponent("Event")),setTimeout((()=>{this.setPosition(s,a),this.setA11yAttr(s,e),i&&this.addEvent(n),n.scene&&this.div.appendChild(s)}),r||this.delay)}transformChange(t){const e=t.component,{gameObject:n}=t,r=n.getComponent(a);if(!r)return;const{a11yId:o}=r;if(e.inScene){if(this.cache.has(o)){const t=this.cache.get(o);t&&this.div.appendChild(t)}}else{const t=this.div.querySelector(`#${o}`);t&&this.div.removeChild(t)}}setEvent(t,e,n,r){if(!e)return;const o=be.bind(this,e,n);this.eventCache.set(r,o),t.addEventListener("click",o)}addEvent(t){const e=t.getComponent(a);if(!e)return;const n=t.getComponent("Event");if(!n)return;const r=this.cache.get(e.a11yId);r&&this.setEvent(r,n,t,e.a11yId)}removeEvent(t){const{gameObject:e}=t,n=e.getComponent(a);if(!n)return;if(!t.component)return;const{a11yId:r}=n,o=this.eventCache.get(r),i=this.cache.get(r);i&&i.removeEventListener("click",o)}setA11yAttr(t,e){const{hint:n,props:r={},state:o={},role:i,a11yId:a}=e,s=i||"text";t.setAttribute("role",s),t.setAttribute("aria-label",n),t.id=a;const c=Object.keys(r);for(const e of c)t.setAttribute(e,r[e]);const h=Object.keys(o);for(const e of h)t.setAttribute(e,o[e]);for(let n of Object.keys(e))"string"==typeof e[n]&&-1===me.indexOf(n)&&1!==n.indexOf("_")&&t.setAttribute(n,e[n])}setPosition(t,e){const{width:n,height:r}=e.size,o={width:0===n?1:n*this.ratioX,height:0===r?1:r*this.ratioY,position:s,zIndex:3,pointerEvents:h.AUTO,background:this.debug?u.DEBUG:u.NONE},a=Object.assign({},e);i(t,o),((t,e,n,r)=>{const{worldTransform:o}=e,{a:i,b:a,c:s,d:c,tx:h,ty:u}=o,p=`matrix(${i}, ${a}, ${s}, ${c}, ${h*n}, ${u*r})`;t.style.transform=`${p}`,t.style.webkitTransform=`${p}`,t.style.transformOrigin="left top",t.style.webkitTransformOrigin="left top"})(t,a,this.ratioX,this.ratioY)}onDestroy(){this.div.parentElement.removeChild(this.div),this.cache=null,this.eventCache=null}};_e.systemName="A11ySystem",_e=r([e.decorators.componentObserver({A11y:[],Transform:["inScene"],Event:[]})],_e);var je=_e;t.A11y=a,t.A11ySystem=je,Object.defineProperty(t,"__esModule",{value:!0})}));

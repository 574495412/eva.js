var e,t;e=this,t=function(e,t){"use strict";function i(e,t,i,s){return new(i||(i=Promise))((function(o,n){function h(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(h,a)}d((s=s.apply(e,t||[])).next())}))}let s=class extends t.System{constructor(e){super(),this.autoPauseAndStart=!0,this.components=[],this.pausedComponents=[],this.audioBufferCache={},this.decodeAudioPromiseMap={},Object.assign(this,e)}get muted(){return!!this.gainNode&&0===this.gainNode.gain.value}set muted(e){this.gainNode&&this.gainNode.gain.setValueAtTime(e?0:1,0)}get volume(){return this.gainNode?this.gainNode.gain.value:1}set volume(e){!this.gainNode||"number"!=typeof e||e<0||e>1||this.gainNode.gain.setValueAtTime(e,0)}get audioLocked(){return!this.ctx||"running"!==this.ctx.state}resumeAll(){const e=()=>{this.pausedComponents.forEach((e=>{e.play()})),this.pausedComponents=[]};this.ctx.resume().then(e,e)}pauseAll(){this.components.forEach((e=>{e.playing&&(this.pausedComponents.push(e),e.pause())})),this.ctx.suspend().then()}stopAll(){this.components.forEach((e=>{e.playing&&e.stop()})),this.pausedComponents=[],this.ctx.suspend().then()}init(){this.setupAudioContext()}update(){const e=this.componentObserver.clear();for(const t of e)this.componentChanged(t)}onPlay(){this.autoPauseAndStart&&this.resumeAll()}onPause(){this.autoPauseAndStart&&this.pauseAll()}onDestroy(){this.components.forEach((e=>{e.onDestroy()})),this.components=[],this.ctx&&(this.gainNode.disconnect(),this.gainNode=null,this.ctx.close(),this.ctx=null)}componentChanged(e){return i(this,void 0,void 0,(function*(){"Sound"===e.componentName&&e.type===t.OBSERVER_TYPE.ADD&&this.add(e)}))}setupAudioContext(){try{const e=window.AudioContext||window.webkitAudioContext;this.ctx=new e}catch(e){console.error(e),this.onError&&this.onError(e)}this.ctx&&(this.gainNode=void 0===this.ctx.createGain?this.ctx.createGainNode():this.ctx.createGain(),this.gainNode.gain.setValueAtTime(this.muted?0:this.volume,this.ctx.currentTime),this.gainNode.connect(this.ctx.destination),this.unlockAudio())}unlockAudio(){if(!this.ctx||!this.audioLocked)return;const e=()=>{if(this.ctx){const t=()=>{document.body.removeEventListener("touchstart",e),document.body.removeEventListener("touchend",e),document.body.removeEventListener("click",e)};this.ctx.resume().then(t,t)}};document.body.addEventListener("touchstart",e),document.body.addEventListener("touchend",e),document.body.addEventListener("click",e)}add(e){return i(this,void 0,void 0,(function*(){const i=e.component;this.components.push(i);try{const{config:e}=i;i.state="loading";const s=yield t.resource.getResource(e.resource);this.audioBufferCache[s.name]||(this.audioBufferCache[s.name]=yield this.decodeAudioData(s.data.audio,s.name)),this.audioBufferCache[s.name]&&(i.systemContext=this.ctx,i.systemDestination=this.gainNode,i.onload(this.audioBufferCache[s.name]))}catch(e){console.error(e),this.onError&&this.onError(e)}}))}decodeAudioData(e,t){if(this.decodeAudioPromiseMap[t])return this.decodeAudioPromiseMap[t];const i=new Promise(((i,s)=>{this.ctx||s(new Error("No audio support")),this.ctx.decodeAudioData(e,(e=>{this.decodeAudioPromiseMap[t]&&delete this.decodeAudioPromiseMap[t],e?i(e):s(new Error(`Error decoding audio ${t}`))}),(i=>{this.decodeAudioPromiseMap[t]&&delete this.decodeAudioPromiseMap[t],s(new Error(`${i}. arrayBuffer byteLength: ${e?e.byteLength:0}`))}))}));return this.decodeAudioPromiseMap[t]=i,i}};s.systemName="SoundSystem",s=function(e,t,i,s){var o,n=arguments.length,h=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(h=(n<3?o(h):n>3?o(t,i,h):o(t,i))||h);return n>3&&h&&Object.defineProperty(t,i,h),h}([t.decorators.componentObserver({Sound:[]})],s);var o=s;class n extends t.Component{constructor(){super(...arguments),this.state="unloaded",this.config={resource:"",autoplay:!1,muted:!1,volume:1,loop:!1,seek:0},this.playTime=0,this.startTime=0,this.duration=0,this.actionQueue=[]}get muted(){return!!this.gainNode&&0===this.gainNode.gain.value}set muted(e){this.gainNode&&this.gainNode.gain.setValueAtTime(e?0:this.config.volume,0)}get volume(){return this.gainNode?this.gainNode.gain.value:1}set volume(e){"number"!=typeof e||e<0||e>1||(this.config.volume=e,this.gainNode&&this.gainNode.gain.setValueAtTime(e,0))}init(e){e&&(Object.assign(this.config,e),this.config.autoplay&&this.actionQueue.push(this.play.bind(this)))}play(){if("loaded"!==this.state&&this.actionQueue.push(this.play.bind(this)),this.destroySource(),this.createSource(),!this.sourceNode)return;const e=this.systemContext.currentTime,t=this.config.seek,i=this.config.duration;this.sourceNode.start(0,t,i),this.startTime=e,this.playTime=e-t,this.paused=!1,this.playing=!0,this.resetConfig(),this.endedListener=()=>{this.sourceNode&&(this.config.onEnd&&this.config.onEnd(),this.playing&&this.destroySource())},this.sourceNode.addEventListener("ended",this.endedListener)}pause(){"loaded"!==this.state&&this.actionQueue.push(this.pause.bind(this)),!this.paused&&this.playing&&(this.paused=!0,this.playing=!1,this.config.seek=this.getCurrentTime(),this.destroySource())}stop(){"loaded"!==this.state&&this.actionQueue.push(this.stop.bind(this)),(this.paused||this.playing)&&(this.playing=!1,this.paused=!1,this.destroySource(),this.resetConfig())}onload(e){this.state="loaded",this.buffer=e,this.duration=this.buffer.duration,this.actionQueue.forEach((e=>e())),this.actionQueue.length=0}onDestroy(){this.actionQueue.length=0,this.destroySource()}resetConfig(){this.config.seek=0}getCurrentTime(){return this.config.loop&&this.duration>0?(this.systemContext.currentTime-this.playTime)%this.duration:this.systemContext.currentTime-this.playTime}createSource(){this.systemContext&&"loaded"===this.state&&(this.sourceNode=this.systemContext.createBufferSource(),this.sourceNode.buffer=this.buffer,this.sourceNode.loop=this.config.loop,this.gainNode||(this.gainNode=this.systemContext.createGain(),this.gainNode.connect(this.systemDestination),Object.assign(this,this.config)),this.sourceNode.connect(this.gainNode))}destroySource(){this.sourceNode&&(this.sourceNode.removeEventListener("ended",this.endedListener),this.sourceNode.stop(),this.sourceNode.disconnect(),this.sourceNode=null,this.startTime=0,this.playTime=0,this.playing=!1)}}n.componentName="Sound",e.Sound=n,e.SoundSystem=o,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@eva/eva.js")):"function"==typeof define&&define.amd?define(["exports","@eva/eva.js"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).EVA=e.EVA||{},e.EVA.plugin=e.EVA.plugin||{},e.EVA.plugin.sound={}),e.EVA);

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).EVA={})}(this,(function(t){"use strict";var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,r)};function r(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}function n(t,e,r,n){var o,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(s=(i<3?o(s):i>3?o(e,r,s):o(e,r))||s);return i>3&&s&&Object.defineProperty(e,r,s),s}function o(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new r((function(e){e(t.value)})).then(s,a)}c((n=n.apply(t,e||[])).next())}))}function i(t,e){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function s(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function a(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function c(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(a(arguments[e]));return t}var u=function(t){var e={exports:{}};return t(e,e.exports),e.exports}((function(t){var e=Object.prototype.hasOwnProperty,r="~";function n(){}function o(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function i(t,e,n,i,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new o(n,i||t,s),c=r?r+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new n:delete t._events[e]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),a.prototype.eventNames=function(){var t,n,o=[];if(0===this._eventsCount)return o;for(n in t=this._events)e.call(t,n)&&o.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(t)):o},a.prototype.listeners=function(t){var e=r?r+t:t,n=this._events[e];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,s=new Array(i);o<i;o++)s[o]=n[o].fn;return s},a.prototype.listenerCount=function(t){var e=r?r+t:t,n=this._events[e];return n?n.fn?1:n.length:0},a.prototype.emit=function(t,e,n,o,i,s){var a=r?r+t:t;if(!this._events[a])return!1;var c,u,l=this._events[a],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(t,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,e),!0;case 3:return l.fn.call(l.context,e,n),!0;case 4:return l.fn.call(l.context,e,n,o),!0;case 5:return l.fn.call(l.context,e,n,o,i),!0;case 6:return l.fn.call(l.context,e,n,o,i,s),!0}for(u=1,c=new Array(h-1);u<h;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var p,f=l.length;for(u=0;u<f;u++)switch(l[u].once&&this.removeListener(t,l[u].fn,void 0,!0),h){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,e);break;case 3:l[u].fn.call(l[u].context,e,n);break;case 4:l[u].fn.call(l[u].context,e,n,o);break;default:if(!c)for(p=1,c=new Array(h-1);p<h;p++)c[p-1]=arguments[p];l[u].fn.apply(l[u].context,c)}}return!0},a.prototype.on=function(t,e,r){return i(this,t,e,r,!1)},a.prototype.once=function(t,e,r){return i(this,t,e,r,!0)},a.prototype.removeListener=function(t,e,n,o){var i=r?r+t:t;if(!this._events[i])return this;if(!e)return s(this,i),this;var a=this._events[i];if(a.fn)a.fn!==e||o&&!a.once||n&&a.context!==n||s(this,i);else{for(var c=0,u=[],l=a.length;c<l;c++)(a[c].fn!==e||o&&!a[c].once||n&&a[c].context!==n)&&u.push(a[c]);u.length?this._events[i]=1===u.length?u[0]:u:s(this,i)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=r?r+t:t,this._events[e]&&s(this,e)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,t.exports=a}));var l=function(t){function e(e){var r=t.call(this)||this;return r.started=!1,r.name=r.constructor.componentName,r.__componentDefaultParams=e,r}return r(e,t),e}(u),h="object"==typeof global&&global&&global.Object===Object&&global,p="object"==typeof self&&self&&self.Object===Object&&self,f=h||p||Function("return this")(),d=f.Symbol,y=Object.prototype,m=y.hasOwnProperty,v=y.toString,_=d?d.toStringTag:void 0;var b=Object.prototype.toString;var g=d?d.toStringTag:void 0;function w(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":g&&g in Object(t)?function(t){var e=m.call(t,_),r=t[_];try{t[_]=void 0;var n=!0}catch(t){}var o=v.call(t);return n&&(e?t[_]=r:delete t[_]),o}(t):function(t){return b.call(t)}(t)}function O(t){return null!=t&&"object"==typeof t}var E=Array.isArray;function T(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function x(t){if(!T(t))return!1;var e=w(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}var j,k=f["__core-js_shared__"],A=(j=/[^.]+$/.exec(k&&k.keys&&k.keys.IE_PROTO||""))?"Symbol(src)_1."+j:"";var S=Function.prototype.toString;function C(t){if(null!=t){try{return S.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var R=/^\[object .+?Constructor\]$/,P=Function.prototype,L=Object.prototype,D=P.toString,M=L.hasOwnProperty,I=RegExp("^"+D.call(M).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function N(t){return!(!T(t)||(e=t,A&&A in e))&&(x(t)?I:R).test(C(t));var e}function B(t,e){var r=function(t,e){return null==t?void 0:t[e]}(t,e);return N(r)?r:void 0}var q=B(f,"WeakMap"),U=/^(?:0|[1-9]\d*)$/;function V(t,e){var r=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&U.test(t))&&t>-1&&t%1==0&&t<e}function F(t,e){return t===e||t!=t&&e!=e}function z(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991}var G=Object.prototype;function X(t){return O(t)&&"[object Arguments]"==w(t)}var J=Object.prototype,Y=J.hasOwnProperty,$=J.propertyIsEnumerable,H=X(function(){return arguments}())?X:function(t){return O(t)&&Y.call(t,"callee")&&!$.call(t,"callee")};var Q="object"==typeof t&&t&&!t.nodeType&&t,W=Q&&"object"==typeof module&&module&&!module.nodeType&&module,K=W&&W.exports===Q?f.Buffer:void 0,Z=(K?K.isBuffer:void 0)||function(){return!1},tt={};tt["[object Float32Array]"]=tt["[object Float64Array]"]=tt["[object Int8Array]"]=tt["[object Int16Array]"]=tt["[object Int32Array]"]=tt["[object Uint8Array]"]=tt["[object Uint8ClampedArray]"]=tt["[object Uint16Array]"]=tt["[object Uint32Array]"]=!0,tt["[object Arguments]"]=tt["[object Array]"]=tt["[object ArrayBuffer]"]=tt["[object Boolean]"]=tt["[object DataView]"]=tt["[object Date]"]=tt["[object Error]"]=tt["[object Function]"]=tt["[object Map]"]=tt["[object Number]"]=tt["[object Object]"]=tt["[object RegExp]"]=tt["[object Set]"]=tt["[object String]"]=tt["[object WeakMap]"]=!1;var et,rt="object"==typeof t&&t&&!t.nodeType&&t,nt=rt&&"object"==typeof module&&module&&!module.nodeType&&module,ot=nt&&nt.exports===rt&&h.process,it=function(){try{var t=nt&&nt.require&&nt.require("util").types;return t||ot&&ot.binding&&ot.binding("util")}catch(t){}}(),st=it&&it.isTypedArray,at=st?(et=st,function(t){return et(t)}):function(t){return O(t)&&z(t.length)&&!!tt[w(t)]},ct=Object.prototype.hasOwnProperty;function ut(t,e){var r=E(t),n=!r&&H(t),o=!r&&!n&&Z(t),i=!r&&!n&&!o&&at(t),s=r||n||o||i,a=s?function(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n}(t.length,String):[],c=a.length;for(var u in t)!e&&!ct.call(t,u)||s&&("length"==u||o&&("offset"==u||"parent"==u)||i&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||V(u,c))||a.push(u);return a}var lt=function(t,e){return function(r){return t(e(r))}}(Object.keys,Object),ht=Object.prototype.hasOwnProperty;function pt(t){if(r=(e=t)&&e.constructor,e!==("function"==typeof r&&r.prototype||G))return lt(t);var e,r,n=[];for(var o in Object(t))ht.call(t,o)&&"constructor"!=o&&n.push(o);return n}function ft(t){return null!=(e=t)&&z(e.length)&&!x(e)?ut(t):pt(t);var e}var dt=B(Object,"create");var yt=Object.prototype.hasOwnProperty;var mt=Object.prototype.hasOwnProperty;function vt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}function _t(t,e){for(var r=t.length;r--;)if(F(t[r][0],e))return r;return-1}vt.prototype.clear=function(){this.__data__=dt?dt(null):{},this.size=0},vt.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},vt.prototype.get=function(t){var e=this.__data__;if(dt){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return yt.call(e,t)?e[t]:void 0},vt.prototype.has=function(t){var e=this.__data__;return dt?void 0!==e[t]:mt.call(e,t)},vt.prototype.set=function(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=dt&&void 0===e?"__lodash_hash_undefined__":e,this};var bt=Array.prototype.splice;function gt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}gt.prototype.clear=function(){this.__data__=[],this.size=0},gt.prototype.delete=function(t){var e=this.__data__,r=_t(e,t);return!(r<0)&&(r==e.length-1?e.pop():bt.call(e,r,1),--this.size,!0)},gt.prototype.get=function(t){var e=this.__data__,r=_t(e,t);return r<0?void 0:e[r][1]},gt.prototype.has=function(t){return _t(this.__data__,t)>-1},gt.prototype.set=function(t,e){var r=this.__data__,n=_t(r,t);return n<0?(++this.size,r.push([t,e])):r[n][1]=e,this};var wt=B(f,"Map");function Ot(t,e){var r,n,o=t.__data__;return("string"==(n=typeof(r=e))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==r:null===r)?o["string"==typeof e?"string":"hash"]:o.map}function Et(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}Et.prototype.clear=function(){this.size=0,this.__data__={hash:new vt,map:new(wt||gt),string:new vt}},Et.prototype.delete=function(t){var e=Ot(this,t).delete(t);return this.size-=e?1:0,e},Et.prototype.get=function(t){return Ot(this,t).get(t)},Et.prototype.has=function(t){return Ot(this,t).has(t)},Et.prototype.set=function(t,e){var r=Ot(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this};function Tt(t){var e=this.__data__=new gt(t);this.size=e.size}Tt.prototype.clear=function(){this.__data__=new gt,this.size=0},Tt.prototype.delete=function(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r},Tt.prototype.get=function(t){return this.__data__.get(t)},Tt.prototype.has=function(t){return this.__data__.has(t)},Tt.prototype.set=function(t,e){var r=this.__data__;if(r instanceof gt){var n=r.__data__;if(!wt||n.length<199)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new Et(n)}return r.set(t,e),this.size=r.size,this};var xt=Object.prototype.propertyIsEnumerable,jt=Object.getOwnPropertySymbols,kt=jt?function(t){return null==t?[]:(t=Object(t),function(t,e){for(var r=-1,n=null==t?0:t.length,o=0,i=[];++r<n;){var s=t[r];e(s,r,t)&&(i[o++]=s)}return i}(jt(t),(function(e){return xt.call(t,e)})))}:function(){return[]};function At(t){return function(t,e,r){var n=e(t);return E(t)?n:function(t,e){for(var r=-1,n=e.length,o=t.length;++r<n;)t[o+r]=e[r];return t}(n,r(t))}(t,ft,kt)}var St=B(f,"DataView"),Ct=B(f,"Promise"),Rt=B(f,"Set"),Pt="[object Map]",Lt="[object Promise]",Dt="[object Set]",Mt="[object WeakMap]",It="[object DataView]",Nt=C(St),Bt=C(wt),qt=C(Ct),Ut=C(Rt),Vt=C(q),Ft=w;(St&&Ft(new St(new ArrayBuffer(1)))!=It||wt&&Ft(new wt)!=Pt||Ct&&Ft(Ct.resolve())!=Lt||Rt&&Ft(new Rt)!=Dt||q&&Ft(new q)!=Mt)&&(Ft=function(t){var e=w(t),r="[object Object]"==e?t.constructor:void 0,n=r?C(r):"";if(n)switch(n){case Nt:return It;case Bt:return Pt;case qt:return Lt;case Ut:return Dt;case Vt:return Mt}return e});var zt=Ft,Gt=f.Uint8Array;function Xt(t){var e=-1,r=null==t?0:t.length;for(this.__data__=new Et;++e<r;)this.add(t[e])}function Jt(t,e){for(var r=-1,n=null==t?0:t.length;++r<n;)if(e(t[r],r,t))return!0;return!1}Xt.prototype.add=Xt.prototype.push=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this},Xt.prototype.has=function(t){return this.__data__.has(t)};function Yt(t,e,r,n,o,i){var s=1&r,a=t.length,c=e.length;if(a!=c&&!(s&&c>a))return!1;var u=i.get(t),l=i.get(e);if(u&&l)return u==e&&l==t;var h=-1,p=!0,f=2&r?new Xt:void 0;for(i.set(t,e),i.set(e,t);++h<a;){var d=t[h],y=e[h];if(n)var m=s?n(y,d,h,e,t,i):n(d,y,h,t,e,i);if(void 0!==m){if(m)continue;p=!1;break}if(f){if(!Jt(e,(function(t,e){if(s=e,!f.has(s)&&(d===t||o(d,t,r,n,i)))return f.push(e);var s}))){p=!1;break}}else if(d!==y&&!o(d,y,r,n,i)){p=!1;break}}return i.delete(t),i.delete(e),p}function $t(t){var e=-1,r=Array(t.size);return t.forEach((function(t,n){r[++e]=[n,t]})),r}function Ht(t){var e=-1,r=Array(t.size);return t.forEach((function(t){r[++e]=t})),r}var Qt=d?d.prototype:void 0,Wt=Qt?Qt.valueOf:void 0;var Kt=Object.prototype.hasOwnProperty;var Zt,te="[object Arguments]",ee="[object Array]",re="[object Object]",ne=Object.prototype.hasOwnProperty;function oe(t,e,r,n,o,i){var s=E(t),a=E(e),c=s?ee:zt(t),u=a?ee:zt(e),l=(c=c==te?re:c)==re,h=(u=u==te?re:u)==re,p=c==u;if(p&&Z(t)){if(!Z(e))return!1;s=!0,l=!1}if(p&&!l)return i||(i=new Tt),s||at(t)?Yt(t,e,r,n,o,i):function(t,e,r,n,o,i,s){switch(r){case"[object DataView]":if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case"[object ArrayBuffer]":return!(t.byteLength!=e.byteLength||!i(new Gt(t),new Gt(e)));case"[object Boolean]":case"[object Date]":case"[object Number]":return F(+t,+e);case"[object Error]":return t.name==e.name&&t.message==e.message;case"[object RegExp]":case"[object String]":return t==e+"";case"[object Map]":var a=$t;case"[object Set]":var c=1&n;if(a||(a=Ht),t.size!=e.size&&!c)return!1;var u=s.get(t);if(u)return u==e;n|=2,s.set(t,e);var l=Yt(a(t),a(e),n,o,i,s);return s.delete(t),l;case"[object Symbol]":if(Wt)return Wt.call(t)==Wt.call(e)}return!1}(t,e,c,r,n,o,i);if(!(1&r)){var f=l&&ne.call(t,"__wrapped__"),d=h&&ne.call(e,"__wrapped__");if(f||d){var y=f?t.value():t,m=d?e.value():e;return i||(i=new Tt),o(y,m,r,n,i)}}return!!p&&(i||(i=new Tt),function(t,e,r,n,o,i){var s=1&r,a=At(t),c=a.length;if(c!=At(e).length&&!s)return!1;for(var u=c;u--;){var l=a[u];if(!(s?l in e:Kt.call(e,l)))return!1}var h=i.get(t),p=i.get(e);if(h&&p)return h==e&&p==t;var f=!0;i.set(t,e),i.set(e,t);for(var d=s;++u<c;){var y=t[l=a[u]],m=e[l];if(n)var v=s?n(m,y,l,e,t,i):n(y,m,l,t,e,i);if(!(void 0===v?y===m||o(y,m,r,n,i):v)){f=!1;break}d||(d="constructor"==l)}if(f&&!d){var _=t.constructor,b=e.constructor;_==b||!("constructor"in t)||!("constructor"in e)||"function"==typeof _&&_ instanceof _&&"function"==typeof b&&b instanceof b||(f=!1)}return i.delete(t),i.delete(e),f}(t,e,r,n,o,i))}function ie(t,e,r,n,o){return t===e||(null==t||null==e||!O(t)&&!O(e)?t!=t&&e!=e:oe(t,e,r,n,ie,o))}function se(t,e){return ie(t,e)}t.OBSERVER_TYPE=void 0,(Zt=t.OBSERVER_TYPE||(t.OBSERVER_TYPE={})).ADD="ADD",Zt.REMOVE="REMOVE",Zt.CHANGE="CHANGE";var ae={},ce={},ue={},le={};function he(t,e){ae[t.gameObject.id]||(ae[t.gameObject.id]={});var r=ae[t.gameObject.id],n=t.name+"_"+e.join(",");if(r[n])return r[n];for(var o=e.length-1,i=t,s=0;s<o;s++)i=i[e[s]];return r[n]={property:i,key:e[o]},r[n]}function pe(t){var e=t.systemName,r=t.componentName,n=t.component,o=t.prop,i=t.type;ce[e].componentObserver.add({component:n,prop:o,type:i,componentName:r})}function fe(e){var r,n,o=e.obj,i=e.key,a=e.prop,c=e.component,u=e.componentName;if(void 0!==o)if(i in o){if(Object.defineProperty(o,"_"+i,{enumerable:!1,writable:!0,value:o[i]}),a.deep&&T(o[i]))try{for(var l=s(Object.keys(o[i])),h=l.next();!h.done;h=l.next()){var p=h.value;fe({obj:o[i],key:p,prop:a,component:c,componentName:u})}}catch(t){r={error:t}}finally{try{h&&!h.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}Object.defineProperty(o,i,{enumerable:!0,set:function(e){o["_"+i]!==e&&(o["_"+i]=e,function(e){var r=e.prop,n=e.component,o=e.componentName;for(var i in ue){var s=(ue[i]||{})[o];s&&s.findIndex((function(t){return se(t,r)}))>-1&&pe({systemName:i,componentName:o,component:n,prop:r,type:t.OBSERVER_TYPE.CHANGE})}}({prop:a,component:c,componentName:u}))},get:function(){return o["_"+i]}})}else console.error("prop "+i+" not in component: "+u+", Can not observer")}function de(e,r){for(var n in void 0===r&&(r=e.name),ue){(ue[n]||{})[r]&&ce[n].componentObserver.add({component:e,type:t.OBSERVER_TYPE.REMOVE,componentName:r})}!function(t){t.gameObject&&delete ae[t.gameObject.id]}(e)}function ye(t,e){t.constructor.IDEProps||(t.constructor.IDEProps=[]),t.constructor.IDEProps.push(e)}var me=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Transform",e._parent=null,e.inScene=!1,e.children=[],e.position={x:0,y:0},e.size={width:0,height:0},e.origin={x:0,y:0},e.anchor={x:0,y:0},e.scale={x:1,y:1},e.skew={x:0,y:0},e.rotation=0,e}return r(e,t),e.prototype.init=function(t){var e,r;void 0===t&&(t={});try{for(var n=s(["position","size","origin","anchor","scale","skew"]),o=n.next();!o.done;o=n.next()){var i=o.value;Object.assign(this[i],t[i])}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}this.rotation=t.rotation||this.rotation},Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},set:function(t){t?t.addChild(this):this.parent&&this.parent.removeChild(this)},enumerable:!1,configurable:!0}),e.prototype.addChild=function(t){if(t.parent===this){var e=this.children.findIndex((function(e){return e===t}));this.children.splice(e,1)}else t.parent&&t.parent.removeChild(t);t._parent=this,this.children.push(t)},e.prototype.removeChild=function(t){var e=this.children.findIndex((function(e){return e===t}));e>-1&&(this.children.splice(e,1),t._parent=null)},e.prototype.clearChildren=function(){this.children.length=0},e.componentName="Transform",n([ye],e.prototype,"position",void 0),n([ye],e.prototype,"size",void 0),n([ye],e.prototype,"origin",void 0),n([ye],e.prototype,"anchor",void 0),n([ye],e.prototype,"scale",void 0),n([ye],e.prototype,"skew",void 0),n([ye],e.prototype,"rotation",void 0),e}(l),ve=0;var _e=function(){function e(t,e){this._componentCache={},this.components=[],this._name=t,this.id=++ve,this.addComponent(me,e)}return Object.defineProperty(e.prototype,"transform",{get:function(){return this.getComponent(me.componentName)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this.transform&&this.transform.parent&&this.transform.parent.gameObject},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(t){var e,r;if(this._scene!==t){var n=this._scene;if(this._scene=t,this.transform&&this.transform.children)try{for(var o=s(this.transform.children),i=o.next();!i.done;i=o.next()){i.value.gameObject.scene=t}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}t?t.addGameObject(this):n&&n.removeGameObject(this)}},enumerable:!1,configurable:!0}),e.prototype.addChild=function(t){if(t&&t.transform&&t!==this){if(!(t instanceof e))throw new Error("addChild only receive GameObject");if(!this.transform)throw new Error("gameObject '"+this.name+"' has been destroy");t.transform.parent=this.transform,t.scene=this.scene}},e.prototype.removeChild=function(t){return t instanceof e&&t.parent&&t.parent===this?(t.transform.parent=null,t.scene=null,t):t},e.prototype.addComponent=function(e,r){var n=function(t){return t instanceof l?t.name:t instanceof Function?t.componentName:void 0}(e);if(!this._componentCache[n]){var o;if(e instanceof Function)o=new e(r);else{if(!(e instanceof l))throw new Error("addComponent recieve Component and Component Constructor");o=e}if(o.gameObject)throw new Error("component has been added on gameObject "+o.gameObject.name);return o.gameObject=this,o.init&&o.init(o.__componentDefaultParams),function(e,r){for(var n in void 0===r&&(r=e.name),ue)(ue[n]||{})[r]&&ce[n].componentObserver.add({component:e,type:t.OBSERVER_TYPE.ADD,componentName:r})}(o,o.name),function(t,e){var r,n;if(void 0===e&&(e=t.name),e&&le[e]){if(!(t&&(o=t,o&&o.constructor&&"componentName"in o.constructor)))throw new Error("component param must be an instance of Component");var o;if(!t.gameObject||!t.gameObject.id)throw new Error("component should be add to a gameObject");try{for(var i=s(le[e]),a=i.next();!a.done;a=i.next()){var c=a.value,u=he(t,c.prop);fe({obj:u.property,key:u.key,prop:c,component:t,componentName:e})}}catch(t){r={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}}}(o,o.name),this.components.push(o),this._componentCache[n]=o,o.awake&&o.awake(),o}},e.prototype.removeComponent=function(t){var e;if("string"==typeof t?e=t:t instanceof l?e=t.name:t.componentName&&(e=t.componentName),"Transform"===e)throw new Error("Transform can't be removed");return this._removeComponent(e)},e.prototype._removeComponent=function(t){var e=this.components.findIndex((function(e){return e.name===t}));if(-1!==e){var r=this.components.splice(e,1)[0];return delete this._componentCache[t],delete r.__componentDefaultParams,r.onDestroy&&r.onDestroy(),de(r,t),r.gameObject=void 0,r}},e.prototype.getComponent=function(t){var e;return"string"==typeof t?e=t:t instanceof l?e=t.name:t.componentName&&(e=t.componentName),void 0!==this._componentCache[e]?this._componentCache[e]:void 0},e.prototype.remove=function(){if(this.parent)return this.parent.removeChild(this)},e.prototype.destroy=function(){for(var t in Array.from(this.transform.children).forEach((function(t){t.gameObject.destroy()})),this.remove(),this.transform.clearChildren(),this._componentCache)this._removeComponent(t);this.components.length=0},e}(),be=function(){function e(){this.events=[]}return e.prototype.add=function(e){var r=e.component,n=e.prop,o=e.type,i=e.componentName;o===t.OBSERVER_TYPE.REMOVE&&(this.events=this.events.filter((function(t){return t.component!==r})));var s=this.events.findIndex((function(t){return t.component===r&&se(t.prop,n)&&t.type===o}));s>-1&&this.events.splice(s,1),this.events.push({gameObject:r.gameObject,component:r,prop:n,type:o,componentName:i})},e.prototype.getChanged=function(){return this.events},Object.defineProperty(e.prototype,"changed",{get:function(){return this.events},enumerable:!1,configurable:!0}),e.prototype.clear=function(){var t=this.events;return this.events=[],t},e}(),ge=function(){function t(t){this.started=!1,this.componentObserver=new be,this.__systemDefaultParams=t,this.name=this.constructor.systemName}return t.prototype.destroy=function(){var t;this.componentObserver=null,this.__systemDefaultParams=null,null===(t=this.onDestroy)||void 0===t||t.call(this)},t}();const we=function(t=!0){let e=null;return e=Date.now?Date.now:()=>(new Date).getTime(),e}(),Oe={originTime:0,playbackRate:1},Ee=Symbol("timeMark"),Te=Symbol("playbackRate"),xe=Symbol("timers"),je=Symbol("originTime"),ke=Symbol("setTimer"),Ae=Symbol("parent");class Se{constructor(t,e){t instanceof Se&&(e=t,t={}),t=Object.assign({},Oe,t),e&&(this[Ae]=e);const r=t.nowtime||we;if(e)Object.defineProperty(this,"globalTime",{get:()=>e.currentTime});else{const t=r();Object.defineProperty(this,"globalTime",{get:()=>r()-t})}this[Ee]=[{globalTime:this.globalTime,localTime:-t.originTime,entropy:-t.originTime,playbackRate:t.playbackRate,globalEntropy:0}],this[Ae]&&(this[Ee][0].globalEntropy=this[Ae].entropy),this[je]=t.originTime,this[Te]=t.playbackRate,this[xe]=new Map}get parent(){return this[Ae]}get lastTimeMark(){return this[Ee][this[Ee].length-1]}markTime({time:t=this.currentTime,entropy:e=this.entropy,playbackRate:r=this.playbackRate}={}){const n={globalTime:this.globalTime,localTime:t,entropy:e,playbackRate:r,globalEntropy:this.globalEntropy};this[Ee].push(n)}get currentTime(){const{localTime:t,globalTime:e}=this.lastTimeMark;return t+(this.globalTime-e)*this.playbackRate}set currentTime(t){const e=this.currentTime,r=t,n=this[xe];this.markTime({time:t}),[...n].forEach((([t,o])=>{if(!n.has(t))return;const{isEntropy:i,delay:s,heading:a}=o.time,{handler:c,startTime:u}=o;if(i)0===s&&(c(),this.clearTimeout(t));else{const n=u+s;(0===s||!1!==a&&(r-e)*s<=0||e<=n&&n<=r||e>=n&&n>=r)&&(c(),this.clearTimeout(t))}})),this.updateTimers()}get entropy(){const{entropy:t,globalEntropy:e}=this.lastTimeMark;return t+Math.abs((this.globalEntropy-e)*this.playbackRate)}get globalEntropy(){return this[Ae]?this[Ae].entropy:this.globalTime}set entropy(t){if(this.entropy>t){const e=this.seekTimeMark(t);this[Ee].length=e+1}this.markTime({entropy:t}),this.updateTimers()}fork(t){return new Se(t,this)}seekGlobalTime(t){const e=this.seekTimeMark(t),r=this[Ee][e],{entropy:n,playbackRate:o,globalTime:i}=r;return i+(t-n)/Math.abs(o)}seekLocalTime(t){const e=this.seekTimeMark(t),r=this[Ee][e],{localTime:n,entropy:o,playbackRate:i}=r;return i>0?n+(t-o):n-(t-o)}seekTimeMark(t){const e=this[Ee];let r=0,n=e.length-1;if(t<=e[r].entropy)return r;if(t>=e[n].entropy)return n;let o=Math.floor((r+n)/2);for(;o>r&&o<n;){if(t===e[o].entropy)return o;t<e[o].entropy?n=o:t>e[o].entropy&&(r=o),o=Math.floor((r+n)/2)}return r}get playbackRate(){return this[Te]}set playbackRate(t){t!==this.playbackRate&&(this.markTime({playbackRate:t}),this[Te]=t,this.updateTimers())}get paused(){if(0===this.playbackRate)return!0;let t=this.parent;for(;t;){if(0===t.playbackRate)return!0;t=t.parent}return!1}updateTimers(){Array.from(this[xe].entries()).forEach((([t,e])=>{this[ke](e.handler,e.time,t)}))}clearTimeout(t){const e=this[xe].get(t);e&&null!=e.timerID&&(this[Ae]?this[Ae].clearTimeout(e.timerID):clearTimeout(e.timerID)),this[xe].delete(t)}clearInterval(t){return this.clearTimeout(t)}clear(){[...this[xe].keys()].forEach((t=>{this.clearTimeout(t)}))}setTimeout(t,e={delay:0}){return this[ke](t,e)}setInterval(t,e={delay:0}){const r=this,n=this[ke]((function o(){r[ke](o,e,n),t()}),e);return n}[ke](t,e,r=Symbol("timerID")){e=function(t){return"number"==typeof t?t={delay:t}:"entropy"in t&&(t={delay:t.entropy,isEntropy:!0}),t}(e);const n=this[xe].get(r);let o,i,s,a=null;n?(this.clearTimeout(r),o=e.isEntropy?(e.delay-(this.entropy-n.startEntropy))/Math.abs(this.playbackRate):(e.delay-(this.currentTime-n.startTime))/this.playbackRate,i=n.startTime,s=n.startEntropy):(o=e.delay/(e.isEntropy?Math.abs(this.playbackRate):this.playbackRate),i=this.currentTime,s=this.entropy);const c=this[Ae],u=c?c.setTimeout.bind(c):setTimeout,l=e.heading;return!c&&!1===l&&o<0&&(o=1/0),(isFinite(o)||c)&&(o=Math.ceil(o),u!==setTimeout&&(o={delay:o,heading:l}),a=u((()=>{this[xe].delete(r),t()}),o)),this[xe].set(r,{timerID:a,handler:t,time:e,startTime:i,startEntropy:s}),r}}var Ce,Re={autoStart:!0,frameRate:60},Pe=function(){function t(t){var e=this;t=Object.assign({},Re,t),this._frameCount=0,this._frameDuration=1e3/t.frameRate,this.autoStart=t.autoStart,this.frameRate=t.frameRate,this.timeline=new Se({originTime:0,playbackRate:1}),this._lastFrameTime=this.timeline.currentTime,this._tickers=new Set,this._requestId=null,this._ticker=function(){e._started&&(e._requestId=requestAnimationFrame(e._ticker),e.update())},this.autoStart&&this.start()}return t.prototype.update=function(){var t,e,r=this.timeline.currentTime,n=r-this._lastFrameTime;if(n>=this._frameDuration){var o=r-n%this._frameDuration,i=o-this._lastFrameTime;this._lastFrameTime=o;var a={deltaTime:i,time:r,currentTime:r,frameCount:++this._frameCount,fps:Math.round(1e3/i)};try{for(var c=s(this._tickers),u=c.next();!u.done;u=c.next()){var l=u.value;"function"==typeof l&&l(a)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(e=c.return)&&e.call(c)}finally{if(t)throw t.error}}}},t.prototype.add=function(t){this._tickers.add(t)},t.prototype.remove=function(t){this._tickers.delete(t)},t.prototype.start=function(){this._started||(this._started=!0,this.timeline.playbackRate=1,this._requestId=requestAnimationFrame(this._ticker))},t.prototype.pause=function(){this._started=!1,this.timeline.playbackRate=0},t}(),Le=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.gameObjects=[],n.scene=n,n}return r(e,t),e.prototype.addGameObject=function(t){this.gameObjects.push(t),t.transform&&(t.transform.inScene=!0)},e.prototype.removeGameObject=function(t){var e=this.gameObjects.indexOf(t);-1!==e&&(t.transform&&(t.transform.inScene=!1),this.gameObjects.splice(e,1))},e.prototype.destroy=function(){this.scene=null,t.prototype.destroy.call(this),this.gameObjects=null,this.canvas=null},e}(_e);t.LOAD_SCENE_MODE=void 0,(Ce=t.LOAD_SCENE_MODE||(t.LOAD_SCENE_MODE={})).SINGLE="SINGLE",Ce.MULTI_CANVAS="MULTI_CANVAS";var De=function(t){if((t instanceof ge||t instanceof l)&&!t.started){t.started=!0;try{t.start&&t.start()}catch(e){t instanceof l?console.error(t.constructor.componentName+" start error",e):console.error(t.constructor.systemName+" start error",e)}}},Me=function(e){function n(t){var r,n,o=void 0===t?{}:t,i=o.systems,a=o.frameRate,c=void 0===a?60:a,u=o.autoStart,l=void 0===u||u,h=o.needScene,p=void 0===h||h,f=e.call(this)||this;if(f.playing=!1,f.started=!1,f.multiScenes=[],f.systems=[],f.ticker=new Pe({autoStart:!1,frameRate:c}),f.initTicker(),i&&i.length)try{for(var d=s(i),y=d.next();!y.done;y=d.next()){var m=y.value;f.addSystem(m)}}catch(t){r={error:t}}finally{try{y&&!y.done&&(n=d.return)&&n.call(d)}finally{if(r)throw r.error}}return p&&f.loadScene(new Le("scene")),l&&f.start(),f}return r(n,e),Object.defineProperty(n.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"gameObjects",{get:function(){return function(t){var e,r,n,o=(null===(n=null==t?void 0:t.scene)||void 0===n?void 0:n.gameObjects)||[],i=null==t?void 0:t.multiScenes.map((function(t){return t.gameObjects})),a=[];try{for(var u=s(i),l=u.next();!l.done;l=u.next())a=c(a,l.value)}catch(t){e={error:t}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(e)throw e.error}}return c(o,a)}(this)},enumerable:!1,configurable:!0}),n.prototype.addSystem=function(t,e){var r;if(t instanceof Function)r=new t(e);else{if(!(t instanceof ge))return void console.warn("can only add System");r=t}if(!this.systems.find((function(t){return t.constructor===r.constructor}))){r.game=this,r.init&&r.init(r.__systemDefaultParams),function(t,e){ue[e.systemName]=e.observerInfo,ce[e.systemName]=t}(r,r.constructor),function(t){var e,r,n,o,i=[];t instanceof Array?i.push.apply(i,c(t)):i.push(t);try{for(var a=s(i),u=a.next();!u.done;u=a.next()){var l=u.value;for(var h in l.observerInfo){le[h]=le[h]||[];var p=le[h],f=function(t){-1===p.findIndex((function(e){return se(e,t)}))&&le[h].push(t)};try{for(var d=(n=void 0,s(l.observerInfo[h])),y=d.next();!y.done;y=d.next())f(y.value)}catch(t){n={error:t}}finally{try{y&&!y.done&&(o=d.return)&&o.call(d)}finally{if(n)throw n.error}}}}}catch(t){e={error:t}}finally{try{u&&!u.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}}(r.constructor);try{r.awake&&r.awake()}catch(t){console.error(r.constructor.systemName+" awake error",t)}return this.systems.push(r),r}console.warn(r.constructor.systemName+" System has been added")},n.prototype.removeSystem=function(t){if(t){var e=-1;"string"==typeof t?e=this.systems.findIndex((function(e){return e.name===t})):t instanceof Function?e=this.systems.findIndex((function(e){return e.constructor===t})):t instanceof ge&&(e=this.systems.findIndex((function(e){return e===t}))),e>-1&&(this.systems[e].destroy&&this.systems[e].destroy(),this.systems.splice(e,1))}},n.prototype.getSystem=function(t){return this.systems.find((function(e){return"string"==typeof t?e.name===t:e instanceof t}))},n.prototype.pause=function(){this.playing&&(this.playing=!1,this.ticker.pause(),this.triggerPause())},n.prototype.start=function(){this.playing||(this.playing=!0,this.started=!0,this.ticker.start())},n.prototype.resume=function(){this.playing||(this.playing=!0,this.ticker.start(),this.triggerResume())},n.prototype.initTicker=function(){var t=this;this.ticker.add((function(e){var r,n,o,i;t.scene&&function(t,e){var r,n,o,i,a,c,u,l;void 0===e&&(e=[]);try{for(var h=s(e),p=h.next();!p.done;p=h.next()){var f=p.value;try{for(var d=(o=void 0,s(f.components)),y=d.next();!y.done;y=d.next()){var m=y.value;try{De(m),m.update&&m.update(t)}catch(t){console.error("gameObject: "+f.name+" "+m.name+" update error",t)}}}catch(t){o={error:t}}finally{try{y&&!y.done&&(i=d.return)&&i.call(d)}finally{if(o)throw o.error}}}}catch(t){r={error:t}}finally{try{p&&!p.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}try{for(var v=s(e),_=v.next();!_.done;_=v.next()){f=_.value;try{for(var b=(u=void 0,s(f.components)),g=b.next();!g.done;g=b.next()){m=g.value;try{m.lateUpdate&&m.lateUpdate(t)}catch(t){console.error("gameObject: "+f.name+" "+m.name+" lateUpdate error",t)}}}catch(t){u={error:t}}finally{try{g&&!g.done&&(l=b.return)&&l.call(b)}finally{if(u)throw u.error}}}}catch(t){a={error:t}}finally{try{_&&!_.done&&(c=v.return)&&c.call(v)}finally{if(a)throw a.error}}}(e,t.gameObjects);try{for(var a=s(t.systems),c=a.next();!c.done;c=a.next()){var u=c.value;try{De(u),u.update&&u.update(e)}catch(e){console.error(u.constructor.systemName+" update error",e)}}}catch(t){r={error:t}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}try{for(var l=s(t.systems),h=l.next();!h.done;h=l.next()){u=h.value;try{u.lateUpdate&&u.lateUpdate(e)}catch(e){console.error(u.constructor.systemName+" lateUpdate error",e)}}}catch(t){o={error:t}}finally{try{h&&!h.done&&(i=l.return)&&i.call(l)}finally{if(o)throw o.error}}}))},n.prototype.triggerResume=function(){var t,e;!function(t){var e,r,n,o;try{for(var i=s(t),a=i.next();!a.done;a=i.next()){var c=a.value;try{for(var u=(n=void 0,s(c.components)),l=u.next();!l.done;l=u.next()){var h=l.value;try{h.onResume&&h.onResume()}catch(t){console.error("gameObject: "+c.name+", "+h.name+", onResume error",t)}}}catch(t){n={error:t}}finally{try{l&&!l.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}(this.gameObjects);try{for(var r=s(this.systems),n=r.next();!n.done;n=r.next()){var o=n.value;try{o.onResume&&o.onResume()}catch(t){console.error(o.constructor.systemName+", onResume error",t)}}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},n.prototype.triggerPause=function(){var t,e;!function(t){var e,r,n,o;try{for(var i=s(t),a=i.next();!a.done;a=i.next()){var c=a.value;try{for(var u=(n=void 0,s(c.components)),l=u.next();!l.done;l=u.next()){var h=l.value;try{h.onPause&&h.onPause()}catch(t){console.error("gameObject: "+c.name+", "+h.name+", onResume error",t)}}}catch(t){n={error:t}}finally{try{l&&!l.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}(this.gameObjects);try{for(var r=s(this.systems),n=r.next();!n.done;n=r.next()){var o=n.value;try{o.onPause&&o.onPause()}catch(t){console.error(o.constructor.systemName+", onPause error",t)}}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},n.prototype.destroySystems=function(){var t,e;try{for(var r=s(c(this.systems)),n=r.next();!n.done;n=r.next()){var o=n.value;this.removeSystem(o)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}this.systems.length=0},n.prototype.destroy=function(){this.removeAllListeners(),this.pause(),this.scene.destroy(),this.destroySystems(),this.ticker=null,this.scene=null,this.canvas=null,this.multiScenes=null},n.prototype.loadScene=function(e){var r=e.scene,n=e.mode,o=void 0===n?t.LOAD_SCENE_MODE.SINGLE:n,i=e.params,s=void 0===i?{}:i;if(r){switch(o){case t.LOAD_SCENE_MODE.SINGLE:this.scene=r;break;case t.LOAD_SCENE_MODE.MULTI_CANVAS:this.multiScenes.push(r)}this.emit("sceneChanged",{scene:r,mode:o,params:s})}},n}(u);function Ie(t){return void 0===t&&(t={}),function(e){if(!e.observerInfo){for(var r in t)for(var n in t[r]){"string"==typeof t[r][n]&&(t[r][n]=[t[r][n]]);var o=void 0;Array.isArray(t[r][n])&&(o={prop:t[r][n],deep:!1},t[r][n]=o),"string"==typeof(o=t[r][n]).prop&&(o.prop=[o.prop])}e.observerInfo=t}}}var Ne=function(){function t(t,e,r){void 0===e&&(e=!1),this.next=null,this.prev=null,this.owner=null,this.fn=t,this.once=e,this.thisArg=r}return t.prototype.detach=function(){return null!==this.owner&&(this.owner.detach(this),!0)},t.prototype.dispose=function(){this.detach()},t}(),Be=function(){function t(){this._head=null,this._tail=null,this._filter=null}return t.prototype.handlers=function(){for(var t=this._head,e=[];t;)e.push(t),t=t.next;return e},t.prototype.hasAny=function(){return!!this._head},t.prototype.has=function(t){return t.owner===this},t.prototype.dispatch=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=this._head;if(!r)return!1;if(this._filter&&!this._filter.apply(this,t))return!1;for(;r;)r.once&&this.detach(r),r.fn.apply(r.thisArg,t),r=r.next;return!0},t.prototype.add=function(t,e){return void 0===e&&(e=null),this._addSignalBinding(new Ne(t,!1,e))},t.prototype.once=function(t,e){return void 0===e&&(e=null),this._addSignalBinding(new Ne(t,!0,e))},t.prototype.detach=function(t){var e=t;return e.owner!==this||(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e===this._head?(this._head=e.next,null===e.next&&(this._tail=null)):e===this._tail&&(this._tail=e.prev,this._tail&&(this._tail.next=null)),e.owner=null),this},t.prototype.detachAll=function(){var t=this._head;if(!t)return this;for(this._head=null,this._tail=null;t;)t.owner=null,t=t.next;return this},t.prototype.filter=function(t){this._filter=t},t.prototype.proxy=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];for(var n=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return t.dispatch.apply(t,e)},o=0;o<e.length;++o)e[o].add(n);return this},t.prototype._addSignalBinding=function(t){var e=t;return this._head?(this._tail&&(this._tail.next=e),e.prev=this._tail,this._tail=e):(this._head=e,this._tail=e),e.owner=this,e},t}();var qe,Ue,Ve=function(t,e){if(t){e=e||{};for(var r={key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},n=r.parser[e.strictMode?"strict":"loose"].exec(t),o={},i=14;i--;)o[r.key[i]]=n[i]||"";return o[r.q.name]={},o[r.key[12]].replace(r.q.parser,(function(t,e,n){e&&(o[r.q.name][e]=n)})),o}},Fe=function(t){this.config=t,this.onError=new Be,this.onComplete=new Be,this.onProgress=new Be},ze=function(t,e){return(ze=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function Ge(t,e){function r(){this.constructor=t}ze(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function Xe(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<r;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,o++)n[o]=i[s];return n}function Je(t){var e="";if(0===t.indexOf("data:")){var r=t.indexOf("/");e=t.substring(r+1,t.indexOf(";",r))}else{var n=t.indexOf("?"),o=t.indexOf("#"),i=Math.min(n>-1?n:t.length,o>-1?o:t.length);e=(t=t.substring(0,i)).substring(t.lastIndexOf(".")+1)}return e.toLowerCase()}function Ye(t){throw new Error("Unexpected value. Should have been never.")}!function(t){t[t.Unknown=0]="Unknown",t[t.Buffer=1]="Buffer",t[t.Blob=2]="Blob",t[t.Json=3]="Json",t[t.Xml=4]="Xml",t[t.Image=5]="Image",t[t.Audio=6]="Audio",t[t.Video=7]="Video",t[t.Text=8]="Text"}(qe||(qe={})),function(t){t[t.NotStarted=0]="NotStarted",t[t.Loading=1]="Loading",t[t.Complete=2]="Complete"}(Ue||(Ue={}));var $e,He=function(t){function e(e,r){var n=t.call(this,e)||this;return n.elementType=r,n._boundOnLoad=n._onLoad.bind(n),n._boundOnError=n._onError.bind(n),n._boundOnTimeout=n._onTimeout.bind(n),n._element=n._createElement(),n._elementTimer=0,n}return Ge(e,t),e.prototype.load=function(){var t=this.config;t.crossOrigin&&(this._element.crossOrigin=t.crossOrigin);var e=t.sourceSet||[t.url];if(navigator.isCocoonJS)this._element.src=e[0];else for(var r=0;r<e.length;++r){var n=e[r],o=t.mimeTypes?t.mimeTypes[r]:void 0;o||(o=this.elementType+"/"+Je(n));var i=document.createElement("source");i.src=n,i.type=o,this._element.appendChild(i)}this._element.addEventListener("load",this._boundOnLoad,!1),this._element.addEventListener("canplaythrough",this._boundOnLoad,!1),this._element.addEventListener("error",this._boundOnError,!1),this._element.load(),t.timeout&&(this._elementTimer=window.setTimeout(this._boundOnTimeout,t.timeout))},e.prototype.abort=function(){for(this._clearEvents();this._element.firstChild;)this._element.removeChild(this._element.firstChild);this._error(this.elementType+" load aborted by the user.")},e.prototype._createElement=function(){return this.config.loadElement?this.config.loadElement:document.createElement(this.elementType)},e.prototype._clearEvents=function(){clearTimeout(this._elementTimer),this._element.removeEventListener("load",this._boundOnLoad,!1),this._element.removeEventListener("canplaythrough",this._boundOnLoad,!1),this._element.removeEventListener("error",this._boundOnError,!1)},e.prototype._error=function(t){this._clearEvents(),this.onError.dispatch(t)},e.prototype._complete=function(){this._clearEvents();var t=qe.Unknown;switch(this.elementType){case"audio":t=qe.Audio;break;case"video":t=qe.Video;break;default:Ye(this.elementType)}this.onComplete.dispatch(t,this._element)},e.prototype._onLoad=function(){this._complete()},e.prototype._onError=function(){this._error(this.elementType+" failed to load.")},e.prototype._onTimeout=function(){this._error(this.elementType+" load timed out.")},e}(Fe),Qe=function(t){function e(e){return t.call(this,e,"audio")||this}return Ge(e,t),e}(He),We=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._boundOnLoad=e._onLoad.bind(e),e._boundOnError=e._onError.bind(e),e._boundOnTimeout=e._onTimeout.bind(e),e._element=e._createElement(),e._elementTimer=0,e}return Ge(e,t),e.prototype.load=function(){var t=this.config;t.crossOrigin&&(this._element.crossOrigin=t.crossOrigin),this._element.src=t.url,this._element.addEventListener("load",this._boundOnLoad,!1),this._element.addEventListener("error",this._boundOnError,!1),t.timeout&&(this._elementTimer=window.setTimeout(this._boundOnTimeout,t.timeout))},e.prototype.abort=function(){this._clearEvents(),this._element.src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",this._error("Image load aborted by the user.")},e.prototype._createElement=function(){return this.config.loadElement?this.config.loadElement:document.createElement("img")},e.prototype._clearEvents=function(){clearTimeout(this._elementTimer),this._element.removeEventListener("load",this._boundOnLoad,!1),this._element.removeEventListener("error",this._boundOnError,!1)},e.prototype._error=function(t){this._clearEvents(),this.onError.dispatch(t)},e.prototype._complete=function(){this._clearEvents(),this.onComplete.dispatch(qe.Image,this._element)},e.prototype._onLoad=function(){this._complete()},e.prototype._onError=function(){this._error("Image failed to load.")},e.prototype._onTimeout=function(){this._error("Image load timed out.")},e}(Fe),Ke=function(t){function e(e){return t.call(this,e,"video")||this}return Ge(e,t),e}(He),Ze=!(!window.XDomainRequest||"withCredentials"in new XMLHttpRequest);function tr(t){return t.toString().replace("object ","")}!function(t){t.Default="text",t.Buffer="arraybuffer",t.Blob="blob",t.Document="document",t.Json="json",t.Text="text"}($e||($e={}));var er=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._boundOnLoad=e._onLoad.bind(e),e._boundOnAbort=e._onAbort.bind(e),e._boundOnError=e._onError.bind(e),e._boundOnTimeout=e._onTimeout.bind(e),e._boundOnProgress=e._onProgress.bind(e),e._xhr=e._createRequest(),e._xhrType=$e.Default,e}return Ge(e,t),e.prototype.load=function(){var t=this.config,e=Je(t.url);"string"!=typeof t.xhrType&&(t.xhrType=this._determineXhrType(e));var r=this._xhr;this._xhrType=t.xhrType||$e.Default,Ze?(r.timeout=t.timeout||5e3,r.onload=this._boundOnLoad,r.onerror=this._boundOnError,r.ontimeout=this._boundOnTimeout,r.onprogress=this._boundOnProgress,r.open("GET",t.url,!0),setTimeout((function(){r.send()}),0)):(r.open("GET",t.url,!0),t.timeout&&(r.timeout=t.timeout),t.xhrType===$e.Json||t.xhrType===$e.Document?r.responseType=$e.Text:r.responseType=t.xhrType,r.addEventListener("load",this._boundOnLoad,!1),r.addEventListener("abort",this._boundOnAbort,!1),r.addEventListener("error",this._boundOnError,!1),r.addEventListener("timeout",this._boundOnTimeout,!1),r.addEventListener("progress",this._boundOnProgress,!1),r.send())},e.prototype.abort=function(){Ze?(this._clearEvents(),this._xhr.abort(),this._onAbort()):this._xhr.abort()},e.prototype._createRequest=function(){return Ze?new window.XDomainRequest:new XMLHttpRequest},e.prototype._determineXhrType=function(t){return e._xhrTypeMap[t]||$e.Default},e.prototype._clearEvents=function(){Ze?(this._xhr.onload=null,this._xhr.onerror=null,this._xhr.ontimeout=null,this._xhr.onprogress=null):(this._xhr.removeEventListener("load",this._boundOnLoad,!1),this._xhr.removeEventListener("abort",this._boundOnAbort,!1),this._xhr.removeEventListener("error",this._boundOnError,!1),this._xhr.removeEventListener("timeout",this._boundOnTimeout,!1),this._xhr.removeEventListener("progress",this._boundOnProgress,!1))},e.prototype._error=function(t){this._clearEvents(),this.onError.dispatch(t)},e.prototype._complete=function(t,e){this._clearEvents(),this.onComplete.dispatch(t,e)},e.prototype._onLoad=function(){var t=this._xhr,e="",r=void 0===t.status?200:t.status;if(void 0!==t.responseType&&""!==t.responseType&&"text"!==t.responseType||(e=t.responseText),0===r&&(e.length>0||t.responseType===$e.Buffer)?r=200:1223===r&&(r=204),200===100*Math.floor(r/100))switch(this._xhrType){case $e.Buffer:this._complete(qe.Buffer,t.response);break;case $e.Blob:this._complete(qe.Blob,t.response);break;case $e.Document:this._parseDocument(e);break;case $e.Json:this._parseJson(e);break;case $e.Default:case $e.Text:this._complete(qe.Text,e);break;default:Ye(this._xhrType)}else this._error("["+t.status+"] "+t.statusText+": "+t.responseURL)},e.prototype._parseDocument=function(t){try{if(window.DOMParser){var e=(new DOMParser).parseFromString(t,"text/xml");this._complete(qe.Xml,e)}else{var r=document.createElement("div");r.innerHTML=t,this._complete(qe.Xml,r)}}catch(t){this._error("Error trying to parse loaded xml: "+t)}},e.prototype._parseJson=function(t){try{var e=JSON.parse(t);this._complete(qe.Json,e)}catch(t){this._error("Error trying to parse loaded json: "+t)}},e.prototype._onAbort=function(){var t=this._xhr;this._error(tr(t)+" Request was aborted by the user.")},e.prototype._onError=function(){var t=this._xhr;this._error(tr(t)+" Request failed. Status: "+t.status+', text: "'+t.statusText+'"')},e.prototype._onTimeout=function(){var t=this._xhr;this._error(tr(t)+" Request timed out.")},e.prototype._onProgress=function(t){t&&t.lengthComputable&&this.onProgress.dispatch(t.loaded/t.total)},e.setExtensionXhrType=function(t,r){t&&0===t.indexOf(".")&&(t=t.substring(1)),t&&(e._xhrTypeMap[t]=r)},e.ResponseType=$e,e._xhrTypeMap={xhtml:$e.Document,html:$e.Document,htm:$e.Document,xml:$e.Document,tmx:$e.Document,svg:$e.Document,tsx:$e.Document,gif:$e.Blob,png:$e.Blob,bmp:$e.Blob,jpg:$e.Blob,jpeg:$e.Blob,tif:$e.Blob,tiff:$e.Blob,webp:$e.Blob,tga:$e.Blob,json:$e.Json,text:$e.Text,txt:$e.Text,ttf:$e.Buffer,otf:$e.Buffer},e}(Fe);function rr(t){var e=t;return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(null===e)throw new Error("Callback was already called.");var n=e;return e=null,n.apply(this,t)}}var nr=function(){function t(t,e){if(void 0===e&&(e=1),this.worker=t,this.concurrency=e,this.workers=0,this.buffer=0,this.paused=!1,this._started=!1,this._tasks=[],this.onSaturated=new Be,this.onUnsaturated=new Be,this.onEmpty=new Be,this.onDrain=new Be,this.onError=new Be,0===e)throw new Error("Concurrency must not be zero");this.buffer=e/4}return Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this.onDrain.detachAll(),this.workers=0,this._started=!1,this._tasks=[]},t.prototype.push=function(t,e){this._insert(t,!1,e)},t.prototype.unshift=function(t,e){this._insert(t,!0,e)},t.prototype.process=function(){for(;!this.paused&&this.workers<this.concurrency&&this._tasks.length;){var t=this._tasks.shift();0===this._tasks.length&&this.onEmpty.dispatch(),this.workers+=1,this.workers===this.concurrency&&this.onSaturated.dispatch(),this.worker(t.data,rr(this._next(t)))}},t.prototype.length=function(){return this._tasks.length},t.prototype.running=function(){return this.workers},t.prototype.idle=function(){return this._tasks.length+this.workers===0},t.prototype.pause=function(){!0!==this.paused&&(this.paused=!0)},t.prototype.resume=function(){if(!1!==this.paused){this.paused=!1;for(var t=1;t<=this.concurrency;t++)this.process()}},t.prototype.getTask=function(t){return this._tasks[t]},t.prototype._insert=function(t,e,r){var n=this;if(null!=r&&"function"!=typeof r)throw new Error("task callback must be a function");if(this._started=!0,null==t&&this.idle())setTimeout((function(){return n.onDrain.dispatch()}),1);else{var o={data:t,callback:r};e?this._tasks.unshift(o):this._tasks.push(o),setTimeout((function(){return n.process()}),1)}},t.prototype._next=function(t){var e=this;return function(r){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e.workers-=1,t.callback&&t.callback.apply(t,Xe([r],n)),r&&e.onError.dispatch(r,t.data),e.workers<=e.concurrency-e.buffer&&e.onUnsaturated.dispatch(),e.idle()&&e.onDrain.dispatch(),e.process()}},t}(),or=function(){function t(e,r){if(this.children=[],this.onStart=new Be,this.onProgress=new Be,this.onComplete=new Be,this.onAfterMiddleware=new Be,this.data=null,this.type=qe.Unknown,this.error="",this.progressChunk=0,this._dequeue=function(){},this._onCompleteBinding=null,this._state=Ue.NotStarted,this.name=e,this.metadata=r.metadata,"string"!=typeof r.crossOrigin&&(r.crossOrigin=this._determineCrossOrigin(r.url)),r.strategy&&"function"!=typeof r.strategy)this._strategy=r.strategy,this._strategy.config=r;else{var n=r.strategy;n||(n=t._loadStrategyMap[Je(r.url)]),n||(n=t._defaultLoadStrategy),this._strategy=new n(r)}this._strategy.onError.add(this._error,this),this._strategy.onComplete.add(this._complete,this),this._strategy.onProgress.add(this._progress,this)}return t.setDefaultLoadStrategy=function(e){t._defaultLoadStrategy=e},t.setLoadStrategy=function(e,r){e&&0===e.indexOf(".")&&(e=e.substring(1)),e&&(t._loadStrategyMap[e]=r)},Object.defineProperty(t.prototype,"strategy",{get:function(){return this._strategy},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"url",{get:function(){return this._strategy.config.url},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isLoading",{get:function(){return this._state===Ue.Loading},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isComplete",{get:function(){return this._state===Ue.Complete},enumerable:!0,configurable:!0}),t.prototype.abort=function(){this._strategy.abort()},t.prototype.load=function(){this._state=Ue.Loading,this.onStart.dispatch(this),this._strategy.load()},t.prototype._error=function(t){this._state=Ue.Complete,this.error=t,this.onComplete.dispatch(this)},t.prototype._complete=function(t,e){this._state=Ue.Complete,this.type=t,this.data=e,this.onComplete.dispatch(this)},t.prototype._progress=function(t){this.onProgress.dispatch(this,t)},t.prototype._determineCrossOrigin=function(e,r){if(void 0===r&&(r=window.location),0===e.indexOf("data:")||0===e.indexOf("javascript:"))return"";if(window.origin!==window.location.origin)return"anonymous";t._tempAnchor||(t._tempAnchor=document.createElement("a")),t._tempAnchor.href=e;var n=Ve(t._tempAnchor.href,{strictMode:!0}),o=!n.port&&""===r.port||n.port===r.port,i=n.protocol?n.protocol+":":"";return n.host===r.hostname&&o&&i===r.protocol?"":"anonymous"},t._tempAnchor=null,t._defaultLoadStrategy=er,t._loadStrategyMap={gif:We,png:We,bmp:We,jpg:We,jpeg:We,tif:We,tiff:We,webp:We,tga:We,svg:We,"svg+xml":We,mp3:Qe,ogg:Qe,wav:Qe,mp4:Ke,webm:Ke,mov:Ke},t}();var ir,sr,ar=/(#[\w-]+)?$/,cr=function(){function t(e,r){void 0===e&&(e=""),void 0===r&&(r=10),this.progress=0,this.loading=!1,this.defaultQueryString="",this.resources={},this.onError=new Be,this.onLoad=new Be,this.onStart=new Be,this.onComplete=new Be,this.onProgress=new Be,this._baseUrl="",this._urlResolvers=[],this._middleware=[],this._resourcesParsing=[],this._boundLoadResource=this._loadResource.bind(this),this.baseUrl=e,this._queue=new nr(this._boundLoadResource,r),this._queue.pause(),this._middleware=t._defaultMiddleware.slice()}return Object.defineProperty(t.prototype,"baseUrl",{get:function(){return this._baseUrl},set:function(t){for(;t.length&&"/"===t.charAt(t.length-1);)t=t.slice(0,-1);this._baseUrl=t},enumerable:!0,configurable:!0}),t.prototype.add=function(t,e){if(Array.isArray(t)){for(var r=0;r<t.length;++r)this.add(t[r]);return this}var n="",o="",i=this._baseUrl,s={url:""};if("object"==typeof t?(n=t.url,o=t.name||t.url,i=t.baseUrl||i,s=t):(o=t,n="string"==typeof e?e:o),!n)throw new Error("You must specify the `url` property.");if(this.loading&&!s.parentResource)throw new Error("Cannot add root resources while the loader is running.");if(this.resources[o])throw new Error('Resource named "'+o+'" already exists.');n=this._prepareUrl(n,i),s.url=n;var a=new or(o,s);if(this.resources[o]=a,"function"==typeof s.onComplete&&a.onAfterMiddleware.once(s.onComplete),this.loading){var c=s.parentResource,u=[];for(r=0;r<c.children.length;++r)c.children[r].isComplete||u.push(c.children[r]);var l=c.progressChunk*(u.length+1)/(u.length+2);c.children.push(a),c.progressChunk=l;for(r=0;r<u.length;++r)u[r].progressChunk=l;a.progressChunk=l}return this._queue.push(a),this},t.prototype.use=function(e,r){return void 0===r&&(r=t.DefaultMiddlewarePriority),this._middleware.push({fn:e,priority:r}),this._middleware.sort((function(t,e){return t.priority-e.priority})),this},t.prototype.reset=function(){for(var t in this.progress=0,this.loading=!1,this._queue.reset(),this._queue.pause(),this.resources){var e=this.resources[t];e&&(e._onCompleteBinding&&e._onCompleteBinding.detach(),e.isLoading&&e.abort())}return this.resources={},this},t.prototype.load=function(t){if("function"==typeof t&&this.onComplete.once(t),this.loading)return this;if(this._queue.idle())this._onStart(),this._onComplete();else{for(var e=100/this._queue.length(),r=0;r<this._queue.length();++r)this._queue.getTask(r).data.progressChunk=e;this._onStart(),this._queue.resume()}return this},Object.defineProperty(t.prototype,"concurrency",{get:function(){return this._queue.concurrency},set:function(t){this._queue.concurrency=t},enumerable:!0,configurable:!0}),t.prototype.addUrlResolver=function(t){return this._urlResolvers.push(t),this},t.prototype._prepareUrl=function(t,e){var r=Ve(t,{strictMode:!0});if(this._urlResolvers.forEach((function(e){t=e(t,r),r=Ve(t,{strictMode:!0})})),r.protocol||0===t.indexOf("//")||(t=e.length&&"/"!==t.charAt(0)?e+"/"+t:e+t),this.defaultQueryString){var n=ar.exec(t);if(n){var o=n[0];-1!==(t=t.substr(0,t.length-o.length)).indexOf("?")?t+="&"+this.defaultQueryString:t+="?"+this.defaultQueryString,t+=o}}return t},t.prototype._loadResource=function(t,e){t._dequeue=e,t._onCompleteBinding=t.onComplete.once(this._onLoad,this),t.load()},t.prototype._onStart=function(){this.progress=0,this.loading=!0,this.onStart.dispatch(this)},t.prototype._onComplete=function(){this.progress=100,this.loading=!1,this.onComplete.dispatch(this,this.resources)},t.prototype._onLoad=function(t){var e=this;t._onCompleteBinding=null,this._resourcesParsing.push(t),t._dequeue(),function(t,e,r,n){void 0===n&&(n=!1);var o=0,i=t.length;!function s(a){a||o===i?r&&r(a):n?setTimeout((function(){return e(t[o++],s)}),1):e(t[o++],s)}()}(this._middleware,(function(r,n){r.fn.call(e,t,n)}),(function(){t.onAfterMiddleware.dispatch(t),e.progress=Math.min(100,e.progress+t.progressChunk),e.onProgress.dispatch(e,t),t.error?e.onError.dispatch(t.error,e,t):e.onLoad.dispatch(e,t),e._resourcesParsing.splice(e._resourcesParsing.indexOf(t),1),e._queue.idle()&&0===e._resourcesParsing.length&&e._onComplete()}),!0)},t.use=function(e,r){return void 0===r&&(r=t.DefaultMiddlewarePriority),t._defaultMiddleware.push({fn:e,priority:r}),t._defaultMiddleware.sort((function(t,e){return t.priority-e.priority})),t},t.DefaultMiddlewarePriority=50,t._defaultMiddleware=[],t}(),ur=function(e){function n(r){var n=r.resource,o=r.resourceTotal,i=e.call(this)||this;return i.progress=0,i.resourceTotal=0,i.resourceLoadedCount=0,i.resource=n,i.resourceTotal=o,0===o&&i.resource.emit(t.LOAD_EVENT.COMPLETE,i),i}return r(n,e),n.prototype.onStart=function(){this.resource.emit(t.LOAD_EVENT.START,this)},n.prototype.onProgress=function(e){this.resourceLoadedCount++,this.progress=Math.floor(this.resourceLoadedCount/this.resourceTotal*100)/100,e.success?this.resource.emit(t.LOAD_EVENT.LOADED,this,e):this.resource.emit(t.LOAD_EVENT.ERROR,this,e),this.resource.emit(t.LOAD_EVENT.PROGRESS,this,e),this.resourceLoadedCount===this.resourceTotal&&this.resource.emit(t.LOAD_EVENT.COMPLETE,this)},n}(u);t.LOAD_EVENT=void 0,(ir=t.LOAD_EVENT||(t.LOAD_EVENT={})).START="start",ir.PROGRESS="progress",ir.LOADED="loaded",ir.COMPLETE="complete",ir.ERROR="error",t.RESOURCE_TYPE=void 0,(sr=t.RESOURCE_TYPE||(t.RESOURCE_TYPE={})).IMAGE="IMAGE",sr.SPRITE="SPRITE",sr.SPRITE_ANIMATION="SPRITE_ANIMATION",sr.DRAGONBONE="DRAGONBONE",sr.SPINE="SPINE",sr.AUDIO="AUDIO",sr.VIDEO="VIDEO",er.setExtensionXhrType("json",$e.Json),er.setExtensionXhrType("tex",$e.Json),er.setExtensionXhrType("ske",$e.Json),er.setExtensionXhrType("mp3",$e.Buffer),er.setExtensionXhrType("wav",$e.Buffer),er.setExtensionXhrType("aac",$e.Buffer),er.setExtensionXhrType("ogg",$e.Buffer);var lr={png:We,jpg:We,jpeg:We,webp:We,json:er,tex:er,ske:er,audio:er,video:Ke},hr=new(function(t){function e(e){var r=t.call(this)||this;return r.timeout=6e3,r.resourcesMap={},r.makeInstanceFunctions={},r.destroyInstanceFunctions={},r.promiseMap={},r.loaders=[],e&&"number"==typeof e.timeout&&(r.timeout=e.timeout),r}return r(e,t),e.prototype.loadConfig=function(t){this.addResource(t),this.preload()},e.prototype.loadSingle=function(t){return this.addResource([t]),this.getResource(t.name)},e.prototype.addResource=function(t){var e,r;if(!t||t.length<1)console.warn("no resources");else try{for(var n=s(t),o=n.next();!o.done;o=n.next()){var i=o.value;this.resourcesMap[i.name]?console.warn(i.name+" was already added"):(this.resourcesMap[i.name]=i,this.resourcesMap[i.name].data={})}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}},e.prototype.preload=function(){var t=Object.values(this.resourcesMap).filter((function(t){return t.preload})).map((function(t){return t.name}));this.progress=new ur({resource:this,resourceTotal:t.length}),this.loadResource({names:t,preload:!0})},e.prototype.getResource=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(e){return this.loadResource({names:[t]}),[2,this.promiseMap[t]||Promise.resolve({})]}))}))},e.prototype.instance=function(t){return o(this,void 0,void 0,(function(){var e,r;return i(this,(function(n){switch(n.label){case 0:return e=this.resourcesMap[t],(r=this.makeInstanceFunctions[e.type])?[4,this.makeInstanceFunctions[e.type](e)]:[3,2];case 1:r=n.sent(),n.label=2;case 2:return[2,r]}}))}))},e.prototype.destroy=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this._destroy(t)];case 1:return e.sent(),[2]}}))}))},e.prototype._destroy=function(t,e){return void 0===e&&(e=!1),o(this,void 0,void 0,(function(){var r,n;return i(this,(function(o){switch(o.label){case 0:if(!(r=this.resourcesMap[t]))return[2];if(e)return[3,5];o.label=1;case 1:return o.trys.push([1,4,,5]),this.destroyInstanceFunctions[r.type]?[4,this.destroyInstanceFunctions[r.type](r)]:[3,3];case 2:o.sent(),o.label=3;case 3:return[3,5];case 4:return n=o.sent(),console.warn("destroy resource "+r.name+" error with '"+n.message+"'"),[3,5];case 5:return delete this.promiseMap[t],r.data={},r.complete=!1,r.instance=void 0,[2]}}))}))},e.prototype.registerInstance=function(t,e){this.makeInstanceFunctions[t]=e},e.prototype.registerDestroy=function(t,e){this.destroyInstanceFunctions[t]=e},e.prototype.loadResource=function(t){var e=this,r=t.names,n=void 0===r?[]:r,o=t.preload,i=void 0!==o&&o,s=n.filter((function(t){return!e.promiseMap[t]&&e.resourcesMap[t]}));if(s.length){var a={},c=this.getLoader(i);s.forEach((function(t){e.promiseMap[t]=new Promise((function(e){return a[t]=e}));var r=e.resourcesMap[t];for(var n in r.src){var o=r.src[n].type;"data"===o?(r.data[n]=r.src[n].data,e.doComplete(t,a[t],i)):c.add({url:r.src[n].url,name:r.name+"_"+n,strategy:lr[o],metadata:{key:n,name:r.name,resolves:a}})}})),c.load()}},e.prototype.doComplete=function(t,e,r){return void 0===r&&(r=!1),o(this,void 0,void 0,(function(){var n,o,s,a;return i(this,(function(i){switch(i.label){case 0:if(n=this.resourcesMap[t],o={name:t,resource:this.resourcesMap[t],success:!0},!this.checkAllLoaded(t))return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),s=n,[4,this.instance(t)];case 2:return s.instance=i.sent(),n.complete=!0,r&&this.progress.onProgress(o),e(n),[3,4];case 3:return a=i.sent(),n.complete=!1,r&&(o.errMsg=a.message,o.success=!1,this.progress.onProgress(o)),e({}),[3,4];case 4:return[2]}}))}))},e.prototype.checkAllLoaded=function(t){var e=this.resourcesMap[t];return Array.from(Object.keys(e.src)).every((function(t){return e.data[t]}))},e.prototype.getLoader=function(t){var e=this;void 0===t&&(t=!1);var r=this.loaders.find((function(t){return!t.loading}));return r||(r=new cr,this.loaders.push(r)),t&&r.onStart.once((function(){e.progress.onStart()})),r.onLoad.add((function(r,n){e.onLoad({preload:t,resource:n})})),r.onError.add((function(r,n,o){e.onError({errMsg:r,resource:o,preload:t})})),r.onComplete.once((function(){r.onLoad.detachAll(),r.onError.detachAll(),r.reset()})),r},e.prototype.onLoad=function(t){var e=t.preload,r=void 0!==e&&e,n=t.resource;return o(this,void 0,void 0,(function(){var t,e,o,s,a;return i(this,(function(i){return t=n.metadata,e=t.key,o=t.name,s=t.resolves,a=n.data,this.resourcesMap[o].data[e]=a,this.doComplete(o,s[o],r),[2]}))}))},e.prototype.onError=function(t){var e=t.errMsg,r=t.preload,n=void 0!==r&&r,s=t.resource;return o(this,void 0,void 0,(function(){var t,r,o,a;return i(this,(function(i){return t=s.metadata,r=t.name,o=t.resolves,this._destroy(r,!0),o[r]({}),n&&(a={name:r,resource:this.resourcesMap[r],success:!1,errMsg:e},this.progress.onProgress(a)),[2]}))}))},e}(u)),pr={IDEProp:ye,componentObserver:Ie};t.Component=l,t.Game=Me,t.GameObject=_e,t.IDEProp=ye,t.Scene=Le,t.System=ge,t.Transform=me,t.componentObserver=Ie,t.decorators=pr,t.resource=hr,Object.defineProperty(t,"__esModule",{value:!0})}));
